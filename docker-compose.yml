version: "3.8"

services:
  db:
    image: kartoza/postgis:15-3.3
    container_name: gis_db
    env_file:
      - ./ndvi_auto/.env
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_DB=moj_gis
      # POSTGRES_PASS se učitava iz ndvi_auto/.env (ne stavljaj šifru ovde)
    ports:
      - "5434:5432"
    volumes:
      - postgres_data:/var/lib/postgresql

  geoserver:
    image: kartoza/geoserver:latest
    container_name: geoserver
    depends_on:
      - db
    env_file:
      - ./ndvi_auto/.env
    environment:
      - GEOSERVER_ADMIN_USER=admin
      # GEOSERVER_ADMIN_PASSWORD se učitava iz ndvi_auto/.env
      - GEOSERVER_DATA_DIR=/opt/geoserver_data
    ports:
      - "8083:8080"
    volumes:
      - geoserver_data:/opt/geoserver_data
      # Control Flow: povećani limiti za WMS (ows.wms.getmap=32 umesto ~8)
      - ./geoserver_config/controlflow.properties:/opt/geoserver_data/controlflow.properties

  ndvi_updater:
    build:
      context: ./ndvi_auto
    container_name: ndvi_updater
    depends_on:
      - geoserver
    env_file:
      - ./ndvi_auto/.env
    environment:
      - GEOSERVER_URL=http://geoserver:8080/geoserver
      - UPDATE_INTERVAL_MINUTES=1440
    volumes:
      - ./ndvi_auto:/app
      - ./satelite:/app/data
    restart: unless-stopped

  parcel_server:
    build:
      context: ./ndvi_auto
    container_name: parcel_server
    depends_on:
      - geoserver
    env_file:
      - ./ndvi_auto/.env
    environment:
      - GEOSERVER_URL=http://geoserver:8080/geoserver
      - PARCEL_SERVER_PORT=5010
    volumes:
      - ./ndvi_auto:/app
      - ./satelite:/app/data
    ports:
      - "5010:5010"
    command: ["python", "/app/parcel_server.py"]
    restart: unless-stopped

  web:
    image: nginx:alpine
    container_name: ndvi_web
    ports:
      - "8088:80"
    volumes:
      - ./:/usr/share/nginx/html:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - geoserver
      - parcel_server
    restart: unless-stopped

volumes:
  postgres_data:
  geoserver_data:
