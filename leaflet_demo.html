<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet + GeoServer WFS (Vektori)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 250px;
        }
        h3 { margin-top: 0; font-size: 16px; }
        p { font-size: 13px; color: #666; }
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #2ecc71;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <div class="controls">
        <h3>GIS Kontrola (WFS)</h3>
        <p>Sada povlačimo <strong>prave vektore</strong>. Granice su interaktivne!</p>
        <div style="font-size: 12px;">
            <span class="legend-color"></span> Granica opštine (latinica)
        </div>
        <div style="font-size: 12px; margin-top: 4px;">
            <span class="legend-color" style="border-color: #e67e22;"></span> Granica opštine (ćirilica)
        </div>
        <hr>
        <small>Kliknite na opštinu za detalje.</small>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Inicijalizacija mape
        var map = L.map('map').setView([44.01, 20.96], 7);

        // 2. Osnovna podloga
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // 3. POVEZIVANJE NA WFS (GeoJSON format)
        // Dodajemo SRSName=EPSG:4326 da bi nam GeoServer vratio koordinate koje Leaflet razume
        var wfsUrl = "http://localhost:8083/geoserver/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:KatOp_Lat&outputFormat=application/json&srsName=EPSG:4326";
        var wfsUrlCir = "http://localhost:8083/geoserver/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:Op_Cir&outputFormat=application/json&srsName=EPSG:4326&format_options=CHARSET:UTF-8";

       

        // Funkcija za stilizaciju granica (latinica)
        function styleOpstina(feature) {
            return {
                color: "#2ecc71",      // Boja granice (zelena)
                weight: 2,             // Debljina linije
                fillOpacity: 0,        // PROZIRNO - bez boje unutra
                opacity: 0.8
            };
        }

        // Stil za ćirilični sloj
        function styleOpstinaCir(feature) {
            return {
                color: "#e67e22",      // Narandžasta
                weight: 2,
                fillOpacity: 0,
                opacity: 0.8
            };
        }

        // Funkcija koja definiše šta se dešava sa svakim objektom (opštinom)
        function onEachFeature(feature, layer) {
            // Popup sa podacima iz baze (ImeKOLatV)
            if (feature.properties && feature.properties.ImeKOLatV) {
                layer.bindPopup("<strong>Opština:</strong> " + fixLatinMojibake(feature.properties.ImeKOLatV));
            }

            // Interakcija na miša (Hover efekat)
            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({
                        weight: 4,
                        color: '#3498db', // Menja u plavu kad se pređe mišem
                        fillOpacity: 0.1
                    });
                },
                mouseout: function (e) {
                    mojVektorskiSloj.resetStyle(e.target);
                }
            });
        }

        function onEachFeatureCir(feature, layer) {
            var cirName = feature.properties && (feature.properties.ImeOV || feature.properties.ImeKOCirV || feature.properties.ImeKOCir || feature.properties.Naziv);
            if (cirName) {
                layer.bindPopup(cirName);
            }

            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({
                        weight: 4,
                        color: '#d35400',
                        fillOpacity: 0.1
                    });
                },
                mouseout: function (e) {
                    mojVektorskiSlojCir.resetStyle(e.target);
                }
            });
        }

        var mojVektorskiSloj;
        var mojVektorskiSlojCir;

        // Fetch zahtev za podatke
        fetch(wfsUrl)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                mojVektorskiSloj = L.geoJSON(data, {
                    style: styleOpstina,
                    onEachFeature: onEachFeature
                }).addTo(map);

                layerControl.addOverlay(mojVektorskiSloj, "Opštine (latinica)");

                // Automatsko zumiranje na sve podatke
                map.fitBounds(mojVektorskiSloj.getBounds());
            })
            .catch(function(error) {
                console.error("Greška kod WFS zahteva:", error);
                alert("Greška: Proverite CORS podešavanja ili da li GeoServer radi.");
            });

        fetch(wfsUrlCir)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                mojVektorskiSlojCir = L.geoJSON(data, {
                    style: styleOpstinaCir,
                    onEachFeature: onEachFeatureCir
                }).addTo(map);

                layerControl.addOverlay(mojVektorskiSlojCir, "Opštine (ćirilica)");
            })
            .catch(function(error) {
                console.error("Greška kod WFS zahteva (Op_Cir):", error);
            });

        // 4. Kontrola slojeva
        var baseMaps = { "OpenStreetMap": osm };
        var layerControl = L.control.layers(baseMaps).addTo(map);

        // 5. Skala
        L.control.scale().addTo(map);
    </script>
</body>
</html>
