<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Leaflet + GeoServer WFS (Vektori)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
        .controls {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 14px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            max-width: 260px;
            border: 1px solid #e6e6e6;
        }
        h3 { margin: 0 0 6px 0; font-size: 15px; }
        p { font-size: 12px; color: #666; margin: 0 0 8px 0; }
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #2ecc71;
            margin-right: 5px;
        }
        .legend-row {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }
        .controls hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 8px 0;
        }
        .controls small {
            color: #666;
        }
        .ndre-snapshot-panel {
            position: absolute;
            right: 12px;
            top: 0; /* postavlja se u JS ispod .controls */
            z-index: 1000;
            max-width: 280px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.15);
            border: 1px solid #e6e6e6;
        }
        .leaflet-control-layers {
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            border: 1px solid #e6e6e6;
        }
        .leaflet-control-layers-expanded {
            padding: 10px 12px;
        }
        .leaflet-control-layers label {
            font-size: 12px;
        }
        .lang-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        .lang-tab {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }
        .lang-tab:hover { background: #f0f0f0; }
        .lang-tab.active { background: #2c7be5; color: #fff; border-color: #2c7be5; }
        .tamis-ogledno-icon { background: none !important; border: none !important; }
        .layer-group-title {
            font-size: 12px;
            font-weight: 600;
            margin: 6px 0 4px;
            color: #333;
        }
        .layer-group {
            margin-top: 6px;
        }
        .meta-bar {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            border: 1px solid #e6e6e6;
            font-size: 12px;
            color: #333;
            max-width: 85%;
            text-align: left;
            display: none;
        }
        .meta-bar div {
            margin: 2px 0;
            white-space: nowrap;
        }
        .parcel-search {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .parcel-search input {
            flex: 1;
            min-width: 140px;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
        }
        .parcel-search button {
            padding: 6px 10px;
            border: 0;
            border-radius: 6px;
            background: #2c7be5;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
        }
        .parcel-search button:hover {
            background: #1f66c0;
        }
        .parcel-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 9999;
            background: #fff;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .parcel-dropdown-item {
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }
        .parcel-dropdown-item:hover {
            background: #e8f0fe;
        }
        .parcel-dropdown-item:last-child {
            border-bottom: none;
        }
        .opacity-control {
            margin: 6px 0 4px;
            font-size: 12px;
            color: #444;
        }
        .opacity-control input[type="range"] {
            width: 100%;
        }
        .auto-report {
            margin-top: 10px;
            padding: 0;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            background: #fafafa;
            font-size: 12px;
            color: #333;
        }
        .auto-report-tabs {
            display: flex;
            gap: 2px;
            padding: 6px 8px 0;
            border-bottom: 1px solid #e0e0e0;
            background: #f0f0f0;
            border-radius: 8px 8px 0 0;
        }
        .auto-report-tab {
            padding: 6px 10px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            border: none;
            background: transparent;
            border-radius: 4px 4px 0 0;
        }
        .auto-report-tab:hover {
            color: #2c7be5;
            background: rgba(44, 123, 229, 0.08);
        }
        .auto-report-tab.active {
            color: #2c7be5;
            background: #fafafa;
            border-bottom: 1px solid #fafafa;
            margin-bottom: -1px;
        }
        .auto-report-content {
            padding: 8px 10px;
            max-height: 280px;
            overflow-y: auto;
        }
        .auto-report-panel {
            display: none;
        }
        .auto-report-panel.active {
            display: block;
        }
        .auto-report strong {
            display: block;
            margin-bottom: 4px;
        }
        .index-info {
            position: absolute;
            bottom: 48px;
            left: 12px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            border: 1px solid #e6e6e6;
            font-size: 12px;
            color: #333;
            max-width: 320px;
            display: none;
        }
        .index-info strong {
            display: block;
            margin-bottom: 4px;
        }
        .time-chart-container {
            margin-top: 10px;
            padding: 8px 10px;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            background: #fafafa;
            font-size: 12px;
            display: none;
        }
        .time-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .time-chart-header:hover {
            color: #2c7be5;
        }
        .time-chart-header strong {
            font-size: 13px;
        }
        .time-chart-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .time-chart-controls button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            font-size: 11px;
            cursor: pointer;
        }
        .time-chart-controls button:hover {
            background: #f0f0f0;
        }
        .time-chart-controls button.active {
            background: #2c7be5;
            color: #fff;
            border-color: #2c7be5;
        }
        .time-chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }
        /* Overlay za grafikon - gornja polovina ekrana */
        #chartOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50vh;
            z-index: 2000;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            flex-direction: column;
        }
        #chartOverlay.visible {
            display: flex;
        }
        #chartOverlay .chart-overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid #e6e6e6;
            background: #fafafa;
            flex-shrink: 0;
        }
        #chartOverlay .chart-overlay-header strong {
            font-size: 15px;
        }
        #chartOverlay .chart-overlay-actions {
            display: flex;
            gap: 8px;
        }
        #chartOverlay .chart-overlay-close,
        #chartOverlay .chart-overlay-download {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }
        #chartOverlay .chart-overlay-close:hover,
        #chartOverlay .chart-overlay-download:hover {
            background: #f0f0f0;
        }
        #chartOverlay .chart-overlay-download {
            border-color: #22c55e;
            color: #22c55e;
        }
        #chartOverlay .chart-overlay-download:hover {
            background: #f0fdf4;
        }
        #chartOverlay .chart-overlay-body {
            flex: 1;
            min-height: 0;
            padding: 10px;
            position: relative;
        }
        #chartOverlay .chart-overlay-body canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .leaflet-control-chart-btn a {
            font-size: 18px !important;
            line-height: 30px !important;
            text-decoration: none !important;
        }
        .measure-length-tooltip {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #2c7be5;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 13px;
            font-weight: 600;
            color: #1a365d;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .measure-length-tooltip::before { border: none; }
        .index-info {
            position: absolute;
            bottom: 12px;
            left: 12px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 14px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            border: 1px solid #e6e6e6;
            font-size: 12px;
            display: none;
            max-width: 250px;
        }
        .index-info strong {
            display: block;
            margin-bottom: 4px;
            color: #2c7be5;
        }
        /* Overlay "Uƒçitavam" ‚Äì providan, mali, mapa manje zamuƒáena */
        .opstine-loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.18);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            animation: opstineOverlayFade 0.25s ease-out;
        }
        @keyframes opstineOverlayFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .opstine-loading-card {
            background: rgba(255, 255, 255, 0.82);
            border-radius: 12px;
            padding: 0.6rem 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.6) inset;
            text-align: center;
            min-width: 100px;
            animation: opstineCardPop 0.25s ease-out;
        }
        @keyframes opstineCardPop {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .opstine-loading-spinner {
            width: 26px;
            height: 26px;
            margin: 0 auto 0.4rem;
            border: 2px solid rgba(30, 64, 175, 0.25);
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: opstineSpin 0.9s linear infinite;
        }
        @keyframes opstineSpin {
            to { transform: rotate(360deg); }
        }
        .opstine-loading-text {
            margin: 0 0 0.1rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e293b;
        }
        .opstine-loading-sub {
            margin: 0;
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <!-- meta bar uklonjen po zahtevu -->
    
    <!-- Info balon za prikaz NDRE/NDVI vrednosti na klik -->
    <div id="indexInfo" class="index-info"></div>

    <!-- Overlay "Uƒçitavam" pri uƒçitavanju sloja Op≈°tine -->
    <div id="opstineLoadingOverlay" class="opstine-loading-overlay" style="display: none;" aria-hidden="true">
        <div class="opstine-loading-card">
            <div class="opstine-loading-spinner"></div>
            <p id="opstineLoadingText" class="opstine-loading-text">Uƒçitavam</p>
            <p id="opstineLoadingSub" class="opstine-loading-sub">Op≈°tine</p>
        </div>
    </div>

    <!-- Overlay: vremenski grafikon preko gornje polovine ekrana -->
    <div id="chartOverlay">
        <div class="chart-overlay-header">
            <strong id="chartOverlayTitle">üìà Vremenski grafikon (poslednjih 5 godina)</strong>
            <div class="chart-overlay-actions">
                <button type="button" class="chart-overlay-download" id="chartOverlayDownload">Download</button>
                <button type="button" class="chart-overlay-close" id="chartOverlayClose">Zatvori</button>
            </div>
        </div>
        <div class="chart-overlay-body">
            <canvas id="timeChartOverlayCanvas"></canvas>
        </div>
    </div>

    <div class="controls">
        <div class="lang-tabs">
            <button type="button" class="lang-tab active" data-lang="srp" aria-pressed="true">SRP</button>
            <button type="button" class="lang-tab" data-lang="eng" aria-pressed="false">ENG</button>
        </div>
        
        <div class="opstina-select" style="margin-bottom: 10px;">
            <label for="opstinaSelect" id="opstinaLabel" style="display: block; font-size: 12px; margin-bottom: 4px; color: #666;">Op≈°tina:</label>
            <select id="opstinaSelect" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                <option value="vrsac_dkp_pg">Vr≈°ac</option>
                <option value="kovin_dkp_pg">Kovin</option>
                <option value="pancevo_dkp_pg">Panƒçevo</option>
            </select>
        </div>
        <div class="kat-opstina-select" style="margin-bottom: 10px;">
            <label for="katOpstinaSelect" id="katOpstinaLabel" style="display: block; font-size: 12px; margin-bottom: 4px; color: #666;">Kat. op≈°tina:</label>
            <select id="katOpstinaSelect" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                <option value=""></option>
            </select>
        </div>
        
        <hr>
        <div class="parcel-search">
            <input id="parcelInput" type="text" placeholder="Parcela npr. 25991" autocomplete="off" />
            <button id="parcelBtn" type="button">Naƒëi</button>
        </div>
        <small id="parcelStatus">Unesite broj parcele za detalje.</small>
        <small id="parcelImageDate" style="display:none; margin-left: 6px;"></small>
        <div id="autoReport" class="auto-report" style="display: none;"></div>
    </div>

    <!-- NDRE snimak ‚Äì levo, samo kad je parcela izabrana i NDRE sloj ukljuƒçen -->
    <div id="ndreZonesLegend" class="ndre-snapshot-panel" style="display: none;">
        <strong id="ndreSnapshotTitle" style="font-size: 12px; display: block; margin-bottom: 6px;">Snimak na mapi (NDVI, NDMI, NDRE)</strong>
        <div style="font-size: 11px; line-height: 1.5; color: #444;">
            <span id="ndreSnapshotCriterion" style="display: block; margin-bottom: 4px;"></span>
            <span id="ndreSnapshotDate" style="display: block; font-weight: 600;"></span>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var i18n = {
            srp: {
                page_title: "Leaflet + GeoServer WFS (Vektori)",
                gis_control: "GIS Kontrola (WFS)",
                opstina: "Op≈°tina:",
                kat_opstina_label: "Katastarska op≈°tina:",
                kat_opstina_placeholder: "‚Äî Izaberi kat. op≈°tinu ‚Äî",
                parcel_placeholder: "Parcela npr. 25991",
                find_btn: "Naƒëi",
                parcel_status_enter: "Unesite broj parcele za detalje.",
                opstine: "Op≈°tine",
                kat_opstine: "Katastarske op≈°tine",
                dkp_vrsac: "DKP-Vr≈°ac",
                dkp_kovin: "DKP-Kovin",
                dkp_pancevo: "DKP-Panƒçevo",
                pancevo_adrese: "Pancevo-adrese",
                tamis_ogledno: "Ogledno Polje - Institut Tami≈°",
                loading: "Uƒçitavam",
                chart_title: "Vremenski grafikon (poslednjih 5 godina)",
                close_btn: "Zatvori",
                download_btn: "Download",
                snapshot_title: "Snimak na mapi (NDVI, NDMI, NDRE)",
                parcel_label: "Parcela:",
                area_label: "Povr≈°ina:",
                status_label: "Status:",
                searching_parcel: "Tra≈æim parcelu",
                parcel_found: "pronaƒëena.",
                parcel_found_full: "Parcela pronaƒëena.",
                parcel_not_found: "Parcela nije pronaƒëena:",
                error_search: "Gre≈°ka pri pretrazi parcele:",
                select_opstina_parcel: "Izaberite op≈°tinu i unesite broj parcele.",
                meri_tooltip: "Meri du≈æinu/povr≈°inu",
                chart_tooltip: "Otvori vremenski grafikon",
                no_data_download: "Nema podataka za preuzimanje. Izaberite parcelu i saƒçekajte da se uƒçitaju CSV podaci.",
                no_csv_display: "Nema CSV fajlova za prikaz.",
                select_parcel_stats: "Izaberite parcelu za prikaz NDVI/NDMI/NDRE statistike.",
                length_label: "Du≈æina:",
                sides_lengths_label: "Du≈æine stranica:",
                area_m2: "Povr≈°ina:",
                stress_drought: "Stres od su≈°e",
                evi: "EVI",
                ndre: "NDRE",
                moisture_index: "Moisture Index",
                transparency: "transparentnost",
                ndvi_parcela: "NDVI (parcela)",
                ndmi_parcela: "NDMI (parcela)",
                ndre_parcela: "NDRE (parcela)",
                ndre_zone_parcela: "NDRE Zone (parcela)",
                csv_error_parcel: "CSV gre≈°ka za parcelu",
                snapshot_from: "Snimak od:",
                snapshot_label: "Snimak:",
                criterion_label: "Kriterijum:",
                date_label: "Datum:",
                valid_pixels_label: "Validni pikseli:",
                cloud_cover_label: "Oblaƒçnost scene:",
                auto_report: "Auto-izve≈°taj",
                cekam_csv: "ƒåekam CSV fajlove...",
                error_opstine_run: "Pokreni: .\\scripts\\setup_geoserver_local.ps1",
                error_kat_run: "Proverite GeoServer i pokrenite setup_geoserver_local.ps1.",
                error_pancevo_run: "Pokreni setup_geoserver_local.ps1.",
                error_wfs_xml: "WFS je vratio XML umesto JSON. Pokreni: .\\scripts\\setup_geoserver_local.ps1",
                total_csv_data: "Ukupno podataka u CSV:",
                total_csv_shown: "Prikazano (poslednjih",
                days_unit: "dana):",
                error_reasons: "Moguƒái razlozi: nema snimaka u tra≈æenom periodu, parcela je van podruƒçja pokrivenosti Sentinel-2 satelita, ili gre≈°ka pri preuzimanju podataka.",
                no_valid_data: "Nema validnih podataka u poslednjih",
                days_suffix: "dana.",
                valid_in_count: "validnih:",
                trend_label: "Trend:",
                loading_layer: "uƒçitava se",
                loading_ndvi: "Uƒçitavam NDVI",
                loading_ndmi: "Uƒçitavam NDMI",
                loading_ndre: "Uƒçitavam NDRE",
                default_opstina: "Op≈°tina",
                default_kat_opstina: "Kat. op≈°tina",
                ogledno_polje_title: "Ogledno polje",
                coordinates_label: "Koordinate:",
                last_days_1: "Poslednjih",
                last_days_2: "dana (validni rezultati, od najnovijeg):",
                pixels_clouds: "Pikseli prekriveni oblacima:",
                min_label: "Min:",
                max_label: "Max:",
                ndvi_mean_label: "NDVI Mean:",
                ndvi_mean_clouds: "NDVI Mean: N/A (oblaci)",
                ndvi_mean_simple: "NDVI mean:",
                min_zone_label: "Min zone:",
                max_zone_label: "Max zone:",
                range_parcel: "Opseg (parcela)",
                interpretation_label: "Tumaƒçenje",
                index_label: "Indeks",
                enable_index_hint: "Ukljuƒçi NDVI, NDMI ili NDRE sloj pa klikni na parcelu.",
                interp_no_data: "nema podataka",
                interp_water_cloud: "voda/senka ili oblak",
                interp_bare_soil: "gola zemlja ili vrlo slaba vegetacija",
                interp_sparse_stress: "retka vegetacija ili moguƒá stres",
                interp_good_veg: "dobra vegetacija",
                interp_dense_healthy: "veoma gusta i zdrava vegetacija",
                interp_very_dry: "veoma suvo",
                interp_dry: "suvo",
                interp_moderate_moisture: "umerena vlaga",
                interp_good_moisture: "dobra vlaga",
                interp_high_moisture: "visoka vlaga",
                interp_weak_veg: "slaba vegetacija",
                interp_moderate_good_veg: "umereno dobra vegetacija",
                interp_very_good_veg: "vrlo dobra vegetacija",
                zone_red: "Crvena zona (vi≈°e azota - mo≈æe manje ƒëubrenja)",
                zone_yellow: "≈Ωuta zona (standardna koliƒçina azota)",
                zone_green: "Zelena zona (manje azota - mo≈æe vi≈°e ƒëubrenja)",
                no_csv_for_parcel: "Nema CSV za parcelu",
                expected_files: "Oƒçekujem:",
                error_label: "Gre≈°ka:"
            },
            eng: {
                page_title: "Leaflet + GeoServer WFS (Vectors)",
                gis_control: "GIS Control (WFS)",
                opstina: "Municipality:",
                kat_opstina_label: "Cadastral municipality:",
                kat_opstina_placeholder: "‚Äî Select cad. municipality ‚Äî",
                parcel_placeholder: "Parcel e.g. 25991",
                find_btn: "Find",
                parcel_status_enter: "Enter parcel number for details.",
                opstine: "Municipalities",
                kat_opstine: "Cadastral municipalities",
                dkp_vrsac: "DKP-Vr≈°ac",
                dkp_kovin: "DKP-Kovin",
                dkp_pancevo: "DKP-Panƒçevo",
                pancevo_adrese: "Pancevo-addresses",
                tamis_ogledno: "Tami≈° Institute - Trial Field",
                loading: "Loading",
                chart_title: "Time chart (last 5 years)",
                close_btn: "Close",
                download_btn: "Download",
                snapshot_title: "Map snapshot (NDVI, NDMI, NDRE)",
                parcel_label: "Parcel:",
                area_label: "Area:",
                status_label: "Status:",
                searching_parcel: "Searching for parcel",
                parcel_found: "found.",
                parcel_found_full: "Parcel found.",
                parcel_not_found: "Parcel not found:",
                error_search: "Error searching parcel:",
                select_opstina_parcel: "Select municipality and enter parcel number.",
                meri_tooltip: "Measure length/area",
                chart_tooltip: "Open time chart",
                no_data_download: "No data to download. Select a parcel and wait for CSV data to load.",
                no_csv_display: "No CSV files to display.",
                select_parcel_stats: "Select a parcel to view NDVI/NDMI/NDRE statistics.",
                length_label: "Length:",
                sides_lengths_label: "Side lengths:",
                area_m2: "Area:",
                stress_drought: "Drought stress",
                evi: "EVI",
                ndre: "NDRE",
                moisture_index: "Moisture Index",
                transparency: "transparency",
                ndvi_parcela: "NDVI (parcel)",
                ndmi_parcela: "NDMI (parcel)",
                ndre_parcela: "NDRE (parcel)",
                ndre_zone_parcela: "NDRE Zones (parcel)",
                csv_error_parcel: "CSV error for parcel",
                snapshot_from: "Snapshot from:",
                snapshot_label: "Snapshot:",
                criterion_label: "Criterion:",
                date_label: "Date:",
                valid_pixels_label: "Valid pixels:",
                cloud_cover_label: "Scene cloud cover:",
                auto_report: "Auto report",
                cekam_csv: "Waiting for CSV files...",
                error_opstine_run: "Run: .\\scripts\\setup_geoserver_local.ps1",
                error_kat_run: "Check GeoServer and run setup_geoserver_local.ps1.",
                error_pancevo_run: "Run setup_geoserver_local.ps1.",
                error_wfs_xml: "WFS returned XML instead of JSON. Run: .\\scripts\\setup_geoserver_local.ps1",
                total_csv_data: "Total CSV rows:",
                total_csv_shown: "Shown (last",
                days_unit: "days):",
                error_reasons: "Possible reasons: no images in the requested period, parcel outside Sentinel-2 coverage, or download error.",
                no_valid_data: "No valid data in the last",
                days_suffix: "days.",
                valid_in_count: "valid:",
                trend_label: "Trend:",
                loading_layer: "loading",
                loading_ndvi: "Loading NDVI",
                loading_ndmi: "Loading NDMI",
                loading_ndre: "Loading NDRE",
                default_opstina: "Municipality",
                default_kat_opstina: "Cad. municipality",
                ogledno_polje_title: "Trial field",
                coordinates_label: "Coordinates:",
                last_days_1: "Last",
                last_days_2: "days (valid results, newest first):",
                pixels_clouds: "Pixels covered by clouds:",
                min_label: "Min:",
                max_label: "Max:",
                ndvi_mean_label: "NDVI Mean:",
                ndvi_mean_clouds: "NDVI Mean: N/A (clouds)",
                ndvi_mean_simple: "NDVI mean:",
                min_zone_label: "Min zone:",
                max_zone_label: "Max zone:",
                range_parcel: "Range (parcel)",
                interpretation_label: "Interpretation",
                index_label: "Index",
                enable_index_hint: "Enable NDVI, NDMI or NDRE layer and click on the parcel.",
                interp_no_data: "no data",
                interp_water_cloud: "water/shadow or cloud",
                interp_bare_soil: "bare soil or very sparse vegetation",
                interp_sparse_stress: "sparse vegetation or possible stress",
                interp_good_veg: "good vegetation",
                interp_dense_healthy: "very dense and healthy vegetation",
                interp_very_dry: "very dry",
                interp_dry: "dry",
                interp_moderate_moisture: "moderate moisture",
                interp_good_moisture: "good moisture",
                interp_high_moisture: "high moisture",
                interp_weak_veg: "sparse vegetation",
                interp_moderate_good_veg: "moderately good vegetation",
                interp_very_good_veg: "very good vegetation",
                zone_red: "Red zone (more nitrogen - less fertiliser needed)",
                zone_yellow: "Yellow zone (standard nitrogen amount)",
                zone_green: "Green zone (less nitrogen - more fertiliser needed)",
                no_csv_for_parcel: "No CSV for parcel",
                expected_files: "Expected:",
                error_label: "Error:"
            }
        };
        var currentLang = localStorage.getItem("leaflet_demo_lang") || "srp";
        function t(key) {
            return (i18n[currentLang] && i18n[currentLang][key]) ? i18n[currentLang][key] : (i18n.srp[key] || key);
        }
        function setLanguage(lang) {
            currentLang = (lang === "eng") ? "eng" : "srp";
            localStorage.setItem("leaflet_demo_lang", currentLang);
            document.querySelectorAll(".lang-tab").forEach(function(btn) {
                var isActive = btn.getAttribute("data-lang") === currentLang;
                btn.classList.toggle("active", isActive);
                btn.setAttribute("aria-pressed", isActive ? "true" : "false");
            });
            document.documentElement.lang = currentLang === "eng" ? "en" : "sr";
            var titleEl = document.getElementById("pageTitle"); if (titleEl) titleEl.textContent = t("page_title");
            var ol = document.getElementById("opstinaLabel"); if (ol) ol.textContent = t("opstina");
            var kol = document.getElementById("katOpstinaLabel"); if (kol) kol.textContent = t("kat_opstina_label");
            var kos = document.getElementById("katOpstinaSelect"); if (kos && kos.options.length > 0) kos.options[0].textContent = t("kat_opstina_placeholder");
            var pi = document.getElementById("parcelInput"); if (pi) pi.placeholder = t("parcel_placeholder");
            var pb = document.getElementById("parcelBtn"); if (pb) pb.textContent = t("find_btn");
            var ps = document.getElementById("parcelStatus"); if (ps) ps.textContent = t("parcel_status_enter");
            var chartStrong = document.getElementById("chartOverlayTitle"); if (chartStrong) chartStrong.textContent = "üìà " + t("chart_title");
            var chartClose = document.getElementById("chartOverlayClose"); if (chartClose) chartClose.textContent = t("close_btn");
            var chartDl = document.getElementById("chartOverlayDownload"); if (chartDl) chartDl.textContent = t("download_btn");
            var ndreLegendStrong = document.getElementById("ndreSnapshotTitle"); if (ndreLegendStrong) ndreLegendStrong.textContent = t("snapshot_title");
            if (typeof updateLayerControlLabelsDom === "function") updateLayerControlLabelsDom();
        }
        document.querySelectorAll(".lang-tab").forEach(function(btn) {
            btn.addEventListener("click", function() { setLanguage(btn.getAttribute("data-lang")); });
        });

        // 1. Inicijalizacija mape ‚Äì pri refreshu zum na granice Beograda
        var map = L.map('map', { maxZoom: 18 }).setView([44.82, 20.46], 10);
        map.createPane('dkpPane');
        map.getPane('dkpPane').style.zIndex = 650;
        var beogradBounds = L.latLngBounds([44.68, 20.25], [44.92, 20.60]); // Beograd (SW, NE)
        var serbiaBounds = L.latLngBounds([42.23, 18.83], [46.19, 23.02]);   // Srbija (pribl.)
        var vrsacBounds = L.latLngBounds([44.92, 21.05], [45.38, 21.62]);     // Op≈°tina Vr≈°ac (pribl.)
        var kovinBounds = L.latLngBounds([44.52, 20.50], [44.96, 21.22]);     // Op≈°tina Kovin (jug=Dunav, zapad=Panƒçevo, istok=Bela Crkva, sever=prema Vr≈°cu)
        var pancevoBounds = L.latLngBounds([44.82, 20.58], [44.92, 20.72]);   // Op≈°tina Panƒçevo (pribl.)
        map.fitBounds(beogradBounds);

        function showOpstineLoadingOverlay(mainText, subText) {
            var el = document.getElementById("opstineLoadingOverlay");
            var t1 = document.getElementById("opstineLoadingText");
            var t2 = document.getElementById("opstineLoadingSub");
            if (t1) t1.textContent = mainText != null ? mainText : t("loading");
            if (t2) t2.textContent = subText != null ? subText : t("opstine");
            if (el) { el.style.display = "flex"; el.setAttribute("aria-hidden", "false"); }
        }
        function hideOpstineLoadingOverlay() {
            var el = document.getElementById("opstineLoadingOverlay");
            if (el) { el.style.display = "none"; el.setAttribute("aria-hidden", "true"); }
        }

        // 2. Osnovna podloga
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        var satellite = L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
            {
                attribution: 'Tiles &copy; Esri'
            }
        );
        // Google Earth ‚Äì isto kao u web2 (Google Satellite, lyrs=s)
        var googleEarth = L.tileLayer('https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            subdomains: '0123',
            attribution: '¬© Google'
        });

        // 3. POVEZIVANJE NA WFS (GeoJSON format)
        // GeoServer URL: localhost lokalno, hostname kada je na serveru
        var geoserverBase = (function() {
            // Uvek preko nginx proxy ‚Äì isti port kao stranica (radi i kad GeoServer nije izlo≈æen na 8083)
            return window.location.origin + "/geoserver";
        })();
        var isServer = (window.location.hostname !== "localhost" && window.location.hostname !== "127.0.0.1");
        // WFS URL-ovi ‚Äì isti format kao DKP (version 1.0.0, outputFormat=application/json).
        // Da bi vratili JSON, na backendu moraju: (1) sloj u GeoServeru, (2) WFS ukljucen za workspace.
        var wfsUrl = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:KatOp_Lat&outputFormat=application/json&srsName=EPSG:4326&format_options=CHARSET:UTF-8";
        var wfsUrlKatOp = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:KatOp_Kat&outputFormat=application/json&srsName=EPSG:4326&format_options=CHARSET:UTF-8";
        var wfsUrlCir = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:Op_Cir&outputFormat=application/json&srsName=EPSG:4326&format_options=CHARSET:UTF-8";
        var wfsUrlDkp = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:vrsac_dkp_pg&outputFormat=application/json&srsName=EPSG:4326";
        var wfsUrlKovin = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:kovin_dkp_pg&outputFormat=application/json&srsName=EPSG:4326";
        var wfsUrlPancevo = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:pancevo_dkp_pg&outputFormat=application/json&srsName=EPSG:4326";
        var wfsUrlPancevoAdrese = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:pancevo_adrese&outputFormat=application/json&srsName=EPSG:4326&format_options=CHARSET:UTF-8";
        var wfsUrlTamis = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:tamis_ogledno_polje&outputFormat=application/json&srsName=EPSG:4326";
        var wfsUrlTamis = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:tamis_ogledno_polje&outputFormat=application/json&srsName=EPSG:4326";

        /** Ispravi srpske znake ako su pogresno dekodovani (CP1250/Windows-1250 bajtovi tretirani kao Latin-1). */
        function fixSrpski(s) {
            if (typeof s !== "string") return s;
            var map = {
                "\u008A": "\u0160", "\u009A": "\u0161",   /* ≈† ≈° (0x8A/0x9A u CP1250 -> kontrolni u Latin-1) */
                "\u008E": "\u017D", "\u009E": "\u017E",   /* ≈Ω ≈æ */
                "\u00C8": "\u010C", "\u00E8": "\u010D",   /* ƒå ƒç */
                "\u00C6": "\u0106", "\u00E6": "\u0107",   /* ƒÜ ƒá */
                "\u00D0": "\u0110", "\u00F0": "\u0111"    /* ƒê ƒë */
            };
            return s.replace(/[\u008A\u009A\u008E\u009E\u00C8\u00E8\u00C6\u00E6\u00D0\u00F0]/g, function(c) { return map[c] || c; });
        }
        function parseJsonResponse(response) {
            return response.text().then(function(txt) {
                if (!response.ok) {
                    var hint = (txt && (txt.toLowerCase().indexOf("<!doctype") !== -1 || txt.toLowerCase().indexOf("<html") !== -1))
                        ? " ‚Äî " + t("error_opstine_run")
                        : "";
                    throw new Error("HTTP " + response.status + hint);
                }
                var trim = txt.trim();
                if (trim.charAt(0) === "<" || trim.indexOf("<?xml") === 0) {
                    var msg = (txt.indexOf("ServiceException") !== -1) ? (txt.match(/<ServiceException[^>]*>([^<]+)/) || [])[1] : null;
                    msg = (msg && typeof msg === "string") ? msg.trim() : "";
                    throw new Error(msg || t("error_wfs_xml"));
                }
                return JSON.parse(txt);
            });
        }
        function fetchWfsJson(url) {
            return fetch(url, { headers: { "Accept": "application/json" } }).then(parseJsonResponse);
        }

        var parcelHighlight;
        var parcelSuggestTimer;
        var opstineLatLayer;
        var katOpstineLayer;
        var dkpLayer;
        var kovinLayer;
        var pancevoLayer;
        var pancevoAdreseLayer;
        var tamisLayer;
        var opstineLatLoaded = false;
        var katOpstineLoaded = false;
        var dkpLoaded = false;
        var kovinLoaded = false;
        var pancevoLoaded = false;
        var pancevoAdreseLoaded = false;
        var tamisLoaded = false;

        function getSelectedOpstina() {
            var select = document.getElementById("opstinaSelect");
            return select ? select.value : "vrsac_dkp_pg";
        }
        function getSelectedKatOpstina() {
            var select = document.getElementById("katOpstinaSelect");
            return select ? (select.value || "") : "";
        }
        /** Sufiks za layer/store naziv: '1146' ili '1146_DUBOVAC' kad je KO izabrana (Op≈°tina/KO/Parcela). */
        function getParcelLayerSuffix(parcelId) {
            var safe = (parcelId || "").replace(/\//g, "_").replace(/\\/g, "_");
            var kat = getSelectedKatOpstina();
            if (kat && kat.trim()) {
                var ko = kat.trim().toUpperCase().replace(/ /g, "_").replace(/\//g, "_").replace(/'/g, "").substring(0, 50);
                safe = safe + "_" + ko;
            }
            return safe;
        }
        function katOpstinaUrlParam() {
            var kat = getSelectedKatOpstina();
            return kat ? "&kat_opstina=" + encodeURIComponent(kat) : "";
        }
        var opstinaToBounds = {
            "vrsac_dkp_pg": [44.92, 21.05, 45.38, 21.62],
            "kovin_dkp_pg": [44.52, 20.50, 44.96, 21.22],
            "pancevo_dkp_pg": [44.82, 20.58, 44.92, 20.72]
        };
        function loadKatOpstineForOpstina() {
            var layerName = getSelectedOpstina();
            var sel = document.getElementById("katOpstinaSelect");
            if (!sel) return;
            sel.innerHTML = "<option value=\"\">" + t("kat_opstina_placeholder") + "</option>";
            if (!layerName) return;
            var url = geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature"
                + "&typeName=moj_projekat:" + encodeURIComponent(layerName)
                + "&outputFormat=application/json&srsName=EPSG:4326"
                + "&propertyName=kat_opst_1&maxFeatures=100000";
            fetch(url).then(parseJsonResponse).then(function(data) {
                var seen = {};
                var items = [];
                (data.features || []).forEach(function(f) {
                    var v = f.properties && f.properties.kat_opst_1;
                    if (v && typeof v === "string" && v.trim() && !seen[v.trim().toUpperCase()]) {
                        seen[v.trim().toUpperCase()] = true;
                        items.push({ value: v.trim(), label: fixSrpski(v.trim()) });
                    }
                });
                items.sort(function(a, b) {
                    var al = (a.label || "").toUpperCase();
                    var bl = (b.label || "").toUpperCase();
                    if (al < bl) return -1;
                    if (al > bl) return 1;
                    return 0;
                });
                items.forEach(function(item) {
                    var opt = document.createElement("option");
                    opt.value = item.value;
                    opt.textContent = item.label;
                    sel.appendChild(opt);
                });
            }).catch(function(err) {
                console.warn("Kat. op≈°tine (KO) nisu uƒçitane:", err);
            });
        }
        
        function buildParcelUrl(parcelId) {
            var cql = "brparcele='" + parcelId.replace(/'/g, "''") + "'";
            var kat = getSelectedKatOpstina();
            if (kat) cql += " AND kat_opst_1 ILIKE '" + kat.replace(/'/g, "''") + "'";
            var layerName = getSelectedOpstina();
            return geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:" + layerName + "&outputFormat=application/json&srsName=EPSG:4326&maxFeatures=1&CQL_FILTER=" + encodeURIComponent(cql);
        }

        function buildParcelSuggestUrl(prefix) {
            var safe = prefix.replace(/'/g, "''");
            var cql = "brparcele ILIKE '" + safe + "%'";
            var kat = getSelectedKatOpstina();
            if (kat) cql += " AND kat_opst_1 ILIKE '" + kat.replace(/'/g, "''") + "'";
            var layerName = getSelectedOpstina();
            return geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:" + layerName + "&outputFormat=application/json&srsName=EPSG:4326&propertyName=brparcele&maxFeatures=12&CQL_FILTER=" + encodeURIComponent(cql);
        }

        function updateParcelOptions(values) {
            var dropdown = document.getElementById("parcelDropdown");
            if (!dropdown) {
                dropdown = document.createElement("div");
                dropdown.id = "parcelDropdown";
                dropdown.className = "parcel-dropdown";
                var input = document.getElementById("parcelInput");
                input.parentNode.style.position = "relative";
                input.parentNode.appendChild(dropdown);
            }
            dropdown.innerHTML = "";
            if (!values || values.length === 0) {
                dropdown.style.display = "none";
                return;
            }
            values.forEach(function(val) {
                var item = document.createElement("div");
                item.className = "parcel-dropdown-item";
                item.textContent = val;
                item.addEventListener("mousedown", function(e) {
                    e.preventDefault();
                    document.getElementById("parcelInput").value = val;
                    dropdown.style.display = "none";
                    zoomToParcel(val);
                });
                dropdown.appendChild(item);
            });
            dropdown.style.display = "block";
        }

        function suggestParcels(prefix) {
            if (!prefix || prefix.length < 2) {
                updateParcelOptions([]);
                return;
            }
            fetch(buildParcelSuggestUrl(prefix))
                .then(parseJsonResponse)
                .then(function(data) {
                    var seen = {};
                    var values = [];
                    (data.features || []).forEach(function(f) {
                        var v = f.properties && f.properties.brparcele;
                        if (v && !seen[v]) {
                            seen[v] = true;
                            values.push(v);
                        }
                    });
                    updateParcelOptions(values);
                })
                .catch(function(err) {
                    console.error("Gre≈°ka kod sugestija parcele:", err);
                });
        }

        function buildParcelPrefixUrl(prefix) {
            var safe = prefix.replace(/'/g, "''");
            var cql = "brparcele ILIKE '" + safe + "%'";
            var kat = getSelectedKatOpstina();
            if (kat) cql += " AND kat_opst_1 ILIKE '" + kat.replace(/'/g, "''") + "'";
            var layerName = getSelectedOpstina();
            return geoserverBase + "/moj_projekat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=moj_projekat:" + layerName + "&outputFormat=application/json&srsName=EPSG:4326&maxFeatures=1&CQL_FILTER=" + encodeURIComponent(cql);
        }

        function zoomToParcel(parcelId) {
            if (!parcelId) {
                return;
            }
            var statusEl = document.getElementById("parcelStatus");
            if (statusEl) {
                statusEl.textContent = t("searching_parcel") + " " + parcelId + "...";
            }
            fetch(buildParcelUrl(parcelId))
                .then(parseJsonResponse)
                .then(function(data) {
                    if (data && data.features && data.features.length) {
                        if (parcelHighlight) {
                            map.removeLayer(parcelHighlight);
                        }
                        parcelHighlight = L.geoJSON(data, {
                            style: {
                                color: "#1abc9c",
                                weight: 3,
                                fillOpacity: 0.1
                            }
                        }).addTo(map);
                        var parcelBounds = parcelHighlight.getBounds();
                        map.fitBounds(parcelBounds, { padding: [20, 20], maxZoom: 18 });
                    setCurrentParcel(parcelId);
                    requestParcelRastersWithCommonDate(parcelId);
                    requestParcelNdviCsv(parcelId);
                    requestParcelNdmiCsv(parcelId);
                        if (statusEl) {
                            statusEl.textContent = t("parcel_label") + " " + parcelId + " " + t("parcel_found");
                        }
                        return;
                    }
                    return fetch(buildParcelPrefixUrl(parcelId))
                        .then(parseJsonResponse)
                        .then(function(prefixData) {
                            if (!prefixData || !prefixData.features || !prefixData.features.length) {
                                if (statusEl) {
                                    statusEl.textContent = t("parcel_not_found") + " " + parcelId;
                                }
                                alert(t("parcel_not_found") + " " + parcelId);
                                return;
                            }
                            if (parcelHighlight) {
                                map.removeLayer(parcelHighlight);
                            }
                            parcelHighlight = L.geoJSON(prefixData, {
                                style: {
                                    color: "#1abc9c",
                                    weight: 3,
                                    fillOpacity: 0.1
                                }
                            }).addTo(map);
                            var parcelBounds = parcelHighlight.getBounds();
                            map.fitBounds(parcelBounds, { padding: [20, 20], maxZoom: 18 });
                            var feature = prefixData.features[0];
                            var pid = feature.properties && feature.properties.brparcele ? feature.properties.brparcele : parcelId;
                            setCurrentParcel(pid);
                            requestParcelRastersWithCommonDate(pid);
                            requestParcelNdviCsv(pid);
                            requestParcelNdmiCsv(pid);
                            if (statusEl) {
                                statusEl.textContent = t("parcel_label") + " " + pid + " " + t("parcel_found");
                            }
                        });
                })
                .catch(function(err) {
                    if (statusEl) {
                        statusEl.textContent = t("error_search") + " " + parcelId + " (" + (err.message || err) + ")";
                    }
                    console.error("Gre≈°ka kod pretrage parcele:", err);
                });
        }

       

        // Funkcija za stilizaciju granica (latinica)
        function styleOpstina(feature) {
            return {
                color: "#2c5282",      // Svetlija tamno-plava granica
                weight: 2,             // Debljina linije
                fillOpacity: 0,        // PROZIRNO - bez boje unutra
                opacity: 0.8
            };
        }

        // Stil za Katastarske op≈°tine (ista shema kao Op≈°tine)
        function styleKatOpstina(feature) {
            return {
                color: "#2c5282",
                weight: 2,
                fillOpacity: 0,
                opacity: 0.8
            };
        }

        // Stil za ƒáiriliƒçni sloj
        function styleOpstinaCir(feature) {
            return {
                color: "#e67e22",      // Narand≈æasta
                weight: 2,
                fillOpacity: 0,
                opacity: 0.8
            };
        }

        // Funkcija koja defini≈°e ≈°ta se de≈°ava sa svakim objektom (op≈°tinom)
        function onEachFeature(feature, layer) {
            var props = feature.properties || {};
            var ime = props.ImeKOLatV || props.imekolatv || props.Naziv || props.naziv || props.ImeOV || props.imeov || props.name || props.NAME || props.opstina || props.Opstina;
            if (!ime || ime === t("default_opstina")) {
                var kLower, v;
                for (var k in props) {
                    if (/^(fid|id|the_geom|geom)$/i.test(k)) continue;
                    v = props[k];
                    if (typeof v !== "string" || v.length < 2) continue;
                    kLower = k.toLowerCase();
                    if (kLower.indexOf("ime") >= 0 || kLower.indexOf("naziv") >= 0 || kLower.indexOf("name") >= 0 || kLower.indexOf("opstina") >= 0) {
                        ime = v; break;
                    }
                }
                if (!ime || ime === t("default_opstina"))
                    for (var k2 in props) {
                        if (/^(fid|id|the_geom|geom)$/i.test(k2)) continue;
                        v = props[k2];
                        if (typeof v === "string" && v.length > 1) { ime = v; break; }
                    }
            }
            if (!ime) ime = t("default_opstina");
            layer.bindPopup(fixSrpski(ime));

            // Interakcija na mi≈°a (Hover efekat)
            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({
                        weight: 4,
                        color: '#60a5fa', // Svetlo-plava pri prelasku mi≈°em
                        fillOpacity: 0.1
                    });
                },
                mouseout: function (e) {
                    mojVektorskiSloj.resetStyle(e.target);
                }
            });
        }

        function onEachFeatureKatOp(feature, layer) {
            var props = feature.properties || {};
            var ime = props.ImeKOLatV || props.imekolatv || props.Naziv || props.naziv || props.ImeOV || props.imeov || props.name || props.NAME || props.opstina || props.Opstina;
            if (!ime || ime === t("default_opstina")) {
                var kLower, v;
                for (var k in props) {
                    if (/^(fid|id|the_geom|geom)$/i.test(k)) continue;
                    v = props[k];
                    if (typeof v !== "string" || v.length < 2) continue;
                    kLower = k.toLowerCase();
                    if (kLower.indexOf("ime") >= 0 || kLower.indexOf("naziv") >= 0 || kLower.indexOf("name") >= 0 || kLower.indexOf("opstina") >= 0) {
                        ime = v; break;
                    }
                }
                if (!ime || ime === t("default_opstina"))
                    for (var k2 in props) {
                        if (/^(fid|id|the_geom|geom)$/i.test(k2)) continue;
                        v = props[k2];
                        if (typeof v === "string" && v.length > 1) { ime = v; break; }
                    }
            }
            if (!ime) ime = t("default_kat_opstina");
            layer.bindPopup(fixSrpski(ime));
            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({ weight: 4, color: '#60a5fa', fillOpacity: 0.1 });
                },
                mouseout: function (e) {
                    katOpstineLayer.resetStyle(e.target);
                }
            });
        }

        function onEachFeatureCir(feature, layer) {
            var cirName = feature.properties && (feature.properties.ImeOV || feature.properties.ImeKOCirV || feature.properties.ImeKOCir || feature.properties.Naziv);
            if (cirName) {
                layer.bindPopup(cirName);
            }

            layer.on({
                mouseover: function (e) {
                    var l = e.target;
                    l.setStyle({
                        weight: 4,
                        color: '#d35400',
                        fillOpacity: 0.1
                    });
                },
                mouseout: function (e) {
                    mojVektorskiSlojCir.resetStyle(e.target);
                }
            });
        }

        function styleDkp(feature) {
            return {
                color: "#8e44ad",
                weight: 1.5,
                fillOpacity: 0.25,
                opacity: 0.9
            };
        }

        function onEachFeatureDkp(feature, layer, dkpTitle) {
            dkpTitle = dkpTitle || "DKP";
            var props = feature.properties || {};
            var parcela = props.brparcele || props.parcela_id || "n/a";
            var pov = props.povrsina ? (props.povrsina + " m2") : "n/a";
            var status = props.dkp_status || props.status_par || props.status || "n/a";
            layer.bindPopup(
                "<strong>" + dkpTitle + "</strong><br>" +
                t("parcel_label") + " " + parcela + "<br>" +
                t("area_label") + " " + pov + "<br>" +
                t("status_label") + " " + status
            );
        }

        // 4. Kontrola slojeva (OSM, Satelit, Google Earth ‚Äì slojevi podloge, isto kao web2)
        var baseMaps = {
            "OpenStreetMap": osm,
            "Satelite": satellite,
            "Google Earth": googleEarth
        };

        opstineLatLayer = L.geoJSON(null, {
            style: styleOpstina,
            onEachFeature: onEachFeature
        });
        var mojVektorskiSloj = opstineLatLayer;
        katOpstineLayer = L.geoJSON(null, {
            style: styleKatOpstina,
            onEachFeature: onEachFeatureKatOp
        });
        dkpLayer = L.geoJSON(null, {
            pane: 'dkpPane',
            style: styleDkp,
            onEachFeature: function(f, l) { onEachFeatureDkp(f, l, t("dkp_vrsac")); }
        });
        kovinLayer = L.geoJSON(null, {
            pane: 'dkpPane',
            style: styleDkp,
            onEachFeature: function(f, l) { onEachFeatureDkp(f, l, t("dkp_kovin")); }
        });
        pancevoLayer = L.geoJSON(null, {
            pane: 'dkpPane',
            style: styleDkp,
            onEachFeature: function(f, l) { onEachFeatureDkp(f, l, t("dkp_pancevo")); }
        });
        pancevoAdreseLayer = L.geoJSON(null, {
            pane: 'dkpPane',
            pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 6,
                    fillColor: "#e74c3c",
                    color: "#c0392b",
                    weight: 1.5,
                    fillOpacity: 0.8,
                    opacity: 1
                });
            },
            style: styleDkp,
            onEachFeature: function(feature, layer) {
                var props = feature.properties || {};
                var adresa = props.adresa || props.Adresa || props.address || props.ulica || props.Ulica || props.naziv || props.Naziv;
                if (!adresa) {
                    var parts = [];
                    for (var k in props) {
                        if (/^(fid|id|the_geom|geom|shape|SHAPE)$/i.test(k)) continue;
                        if (typeof props[k] === "string" && props[k].length > 0) parts.push(props[k]);
                    }
                    adresa = parts.slice(0, 3).join(", ") || "Adresa";
                }
                layer.bindPopup("<strong>Panƒçevo</strong><br>" + fixSrpski(adresa));
                layer.on({ mouseover: function(e) { e.target.setStyle({ radius: 8, fillOpacity: 1 }); }, mouseout: function(e) { e.target.setStyle({ radius: 6, fillOpacity: 0.8 }); } });
            }
        });
        
        var TAMIS_LAT = 44.939388889;
        var TAMIS_LON = 20.722527778;
        var tamisGeoJSON = {
            type: "FeatureCollection",
            features: [{
                type: "Feature",
                properties: { name: "Ogledno polje - Institut Tami≈°", lat_dms: "44¬∞56'21.8\"N", lon_dms: "20¬∞43'21.1\"E" },
                geometry: { type: "Point", coordinates: [TAMIS_LON, TAMIS_LAT] }
            }]
        };
        var tamisIcon = L.divIcon({
            html: '<span style="font-size:32px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.4));display:block;text-align:center">üåæ</span>',
            className: "tamis-ogledno-icon",
            iconSize: [36, 36],
            iconAnchor: [18, 36],
            popupAnchor: [0, -36]
        });
        tamisLayer = L.geoJSON(tamisGeoJSON, {
            pointToLayer: function(feature, latlng) {
                return L.marker(latlng, { icon: tamisIcon });
            },
            onEachFeature: function(feature, layer) {
                var props = feature.properties || {};
                var popupContent = "<strong>" + t("ogledno_polje_title") + "</strong><br>" + (props.name || "") + "<br>" + t("coordinates_label") + " " + (props.lat_dms || "") + " " + (props.lon_dms || "");
                layer.bindPopup(popupContent);
            }
        });

        var overlayMaps = {
            [t("opstine")]: opstineLatLayer,
            [t("kat_opstine")]: katOpstineLayer,
            [t("dkp_vrsac")]: dkpLayer,
            [t("dkp_kovin")]: kovinLayer,
            [t("dkp_pancevo")]: pancevoLayer,
            [t("pancevo_adrese")]: pancevoAdreseLayer,
            [t("tamis_ogledno")]: tamisLayer
        };
        var layerControl = L.control.layers(baseMaps, overlayMaps, { position: 'topleft' }).addTo(map);

        var overlayRegistry = [
            { layer: opstineLatLayer, key: "opstine" },
            { layer: katOpstineLayer, key: "kat_opstine" },
            { layer: dkpLayer, key: "dkp_vrsac" },
            { layer: kovinLayer, key: "dkp_kovin" },
            { layer: pancevoLayer, key: "dkp_pancevo" },
            { layer: pancevoAdreseLayer, key: "pancevo_adrese" },
            { layer: tamisLayer, key: "tamis_ogledno" }
        ];
        var parcelOverlayRegistry = [];
        function updateLayerControlLabelsDom() {
            if (!layerControl || !layerControl._container) return;
            function setLabelForLayer(r) {
                var id = L.Util.stamp(r.layer);
                var input = layerControl._container.querySelector('input[name="leaflet-layer-' + id + '"]');
                if (!input || !input.parentNode) return;
                var label = input.parentNode;
                var span = label.querySelector('span');
                var text = t(r.key);
                if (span) {
                    span.textContent = text;
                } else {
                    var nodes = label.childNodes;
                    for (var i = 0; i < nodes.length; i++) {
                        if (nodes[i] && nodes[i].nodeType === 3) {
                            nodes[i].textContent = text;
                            return;
                        }
                        if (nodes[i] && nodes[i] !== input && nodes[i].nodeType === 1) {
                            nodes[i].textContent = text;
                            return;
                        }
                    }
                }
            }
            overlayRegistry.forEach(setLabelForLayer);
            parcelOverlayRegistry.forEach(setLabelForLayer);
        }
        setLanguage(currentLang);

        // Mali balonƒçiƒá pri kliku na parcelu (padajuƒái meni / DKP sloj) ‚Äì nestaje posle 0,5 s
        map.on("popupopen", function(e) {
            var content = e.popup.getContent();
            var str = typeof content === "string" ? content : (content && content.innerHTML ? content.innerHTML : "");
            if (str.indexOf(t("parcel_label")) !== -1 || str.indexOf("DKP") !== -1 || str.indexOf("Panƒçevo") !== -1) {
                setTimeout(function() {
                    try { map.closePopup(e.popup); } catch (err) {}
                }, 500);
            }
        });

        function loadOpstineLat() {
            if (opstineLatLoaded) return Promise.resolve();
            opstineLatLoaded = true;
            return fetchWfsJson(wfsUrl)
                .then(function(data) {
                    if (data.features && data.features.length > 0) {
                        opstineLatLayer.addData(data);
                    }
                })
                .catch(function(error) {
                    console.error("Gre≈°ka kod WFS zahteva:", error);
                    alert(t("opstine") + ": " + (error.message || t("error_opstine_run")));
                });
        }

        function loadKatOpstine() {
            if (katOpstineLoaded) return Promise.resolve();
            katOpstineLoaded = true;
            return fetchWfsJson(wfsUrlKatOp)
                .then(function(data) {
                    if (data.features && data.features.length > 0) {
                        katOpstineLayer.addData(data);
                    }
                })
                .catch(function(error) {
                    console.error("Gre≈°ka kod WFS za Katastarske op≈°tine:", error);
                    alert(t("kat_opstine") + ": " + (error.message || t("error_kat_run")));
                });
        }

        function loadDkp() {
            if (dkpLoaded) return Promise.resolve();
            dkpLoaded = true;
            var bounds = map.getBounds();
            var bbox = bounds.getWest() + "," + bounds.getSouth() + "," + bounds.getEast() + "," + bounds.getNorth();
            var wfsUrlDkpBbox = wfsUrlDkp + "&bbox=" + bbox;
            return fetch(wfsUrlDkpBbox)
                .then(function(response) { 
                    if (!response.ok) {
                        throw new Error("HTTP " + response.status);
                    }
                    return response.json(); 
                })
                .then(function(data) {
                    if (data.features && data.features.length > 0) {
                        dkpLayer.addData(data);
                        dkpLayer.bringToFront();
                        console.log("Vr≈°ac uƒçitano sa bbox:", data.features.length, "feature-a");
                    }
                    return fetch(wfsUrlDkp);
                })
                .then(function(response) {
                    if (response && response.ok) {
                        return response.json();
                    }
                    return null;
                })
                .then(function(data) {
                    if (data && data.features && data.features.length > 0) {
                        dkpLayer.addData(data);
                        dkpLayer.bringToFront();
                        console.log("Vr≈°ac uƒçitano sve:", data.features.length, "feature-a");
                    }
                })
                .catch(function(error) {
                    console.error("Gre≈°ka kod WFS zahteva (DKP-Vrsac):", error);
                    return fetch(wfsUrlDkp)
                        .then(function(response) { return response.json(); })
                        .then(function(data) {
                            if (data.features && data.features.length > 0) {
                                dkpLayer.addData(data);
                                dkpLayer.bringToFront();
                                console.log("Vr≈°ac uƒçitano (fallback):", data.features.length, "feature-a");
                            }
                        })
                        .catch(function(err) {
                            console.error("Gre≈°ka kod WFS zahteva (fallback):", err);
                        });
                });
        }

        function loadKovin() {
            if (kovinLoaded) return Promise.resolve();
            kovinLoaded = true;
            function addKovinData(data) {
                if (data && data.features && data.features.length > 0) {
                    kovinLayer.addData(data);
                    kovinLayer.bringToFront();
                    console.log("Kovin uƒçitano:", data.features.length, "feature-a");
                    return true;
                }
                return false;
            }
            function parseJsonResp(response) {
                return response.text().then(function(txt) {
                    if (!response.ok) throw new Error("HTTP " + response.status + ": " + txt.slice(0, 200));
                    try { return JSON.parse(txt); } catch (e) { throw new Error("Nije JSON: " + txt.slice(0, 200)); }
                });
            }
            var bounds = map.getBounds();
            var bbox = bounds.getWest() + "," + bounds.getSouth() + "," + bounds.getEast() + "," + bounds.getNorth();
            var wfsUrlBbox = wfsUrlKovin + "&bbox=" + bbox;
            return fetch(wfsUrlBbox)
                .then(parseJsonResp)
                .then(function(data) {
                    if (data && data.features && data.features.length > 0) {
                        addKovinData(data);
                    }
                    return fetch(wfsUrlKovin);
                })
                .then(parseJsonResp)
                .then(function(data) {
                    addKovinData(data);
                })
                .catch(function(error) {
                    console.error("Gre≈°ka WFS DKP-Kovin:", error);
                    kovinLoaded = false;
                    return fetch(wfsUrlKovin).then(parseJsonResp).then(function(data) {
                        if (addKovinData(data)) kovinLoaded = true;
                    }).catch(function(err) {
                        console.error("Fallback WFS gre≈°ka:", err);
                    });
                });
        }

        function loadPancevo() {
            if (pancevoLoaded) return Promise.resolve();
            pancevoLoaded = true;
            var bounds = map.getBounds();
            var bbox = bounds.getWest() + "," + bounds.getSouth() + "," + bounds.getEast() + "," + bounds.getNorth();
            var wfsUrlPancevoBbox = wfsUrlPancevo + "&bbox=" + bbox;
            return fetch(wfsUrlPancevoBbox)
                .then(function(response) { 
                    if (!response.ok) {
                        throw new Error("HTTP " + response.status);
                    }
                    return response.json(); 
                })
                .then(function(data) {
                    if (data.features && data.features.length > 0) {
                        pancevoLayer.addData(data);
                        pancevoLayer.bringToFront();
                        console.log("Panƒçevo uƒçitano sa bbox:", data.features.length, "feature-a");
                    }
                    return fetch(wfsUrlPancevo);
                })
                .then(function(response) {
                    if (response && response.ok) {
                        return response.json();
                    }
                    return null;
                })
                .then(function(data) {
                    if (data && data.features && data.features.length > 0) {
                        pancevoLayer.addData(data);
                        pancevoLayer.bringToFront();
                        console.log("Panƒçevo uƒçitano sve:", data.features.length, "feature-a");
                    }
                })
                .catch(function(error) {
                    console.error("Gre≈°ka kod WFS zahteva (DKP-Pancevo):", error);
                    return fetch(wfsUrlPancevo)
                        .then(function(response) { return response.json(); })
                        .then(function(data) {
                            if (data.features && data.features.length > 0) {
                                pancevoLayer.addData(data);
                                pancevoLayer.bringToFront();
                                console.log("Panƒçevo uƒçitano (fallback):", data.features.length, "feature-a");
                            }
                        })
                        .catch(function(err) {
                            console.error("Gre≈°ka kod WFS zahteva (fallback):", err);
                        });
                });
        }

        function loadPancevoAdrese() {
            if (pancevoAdreseLoaded) return;
            pancevoAdreseLoaded = true;
            var bounds = map.getBounds();
            var bbox = bounds.getWest() + "," + bounds.getSouth() + "," + bounds.getEast() + "," + bounds.getNorth();
            var wfsUrlPancevoAdreseBbox = wfsUrlPancevoAdrese + "&bbox=" + bbox;
            fetchWfsJson(wfsUrlPancevoAdreseBbox)
                .then(function(data) {
                    if (data.features && data.features.length > 0) {
                        pancevoAdreseLayer.addData(data);
                        pancevoAdreseLayer.bringToFront();
                        console.log("Panƒçevo-adrese uƒçitano sa bbox:", data.features.length, "feature-a");
                    }
                    return fetchWfsJson(wfsUrlPancevoAdrese);
                })
                .then(function(data) {
                    if (data && data.features && data.features.length > 0) {
                        pancevoAdreseLayer.addData(data);
                        pancevoAdreseLayer.bringToFront();
                        console.log("Panƒçevo-adrese uƒçitano sve:", data.features.length, "feature-a");
                    }
                })
                .catch(function(error) {
                    console.error("Gre≈°ka kod WFS zahteva (Pancevo-adrese):", error);
                    alert(t("pancevo_adrese") + ": " + (error.message || t("error_pancevo_run")));
                });
        }

        // 4a. Parcel rasteri (WMS) ‚Äì tile caching samo za povr≈°ine > 1 km¬≤
        // Parcele (~5 ha) ispod praga = direktan WMS render
        var ndviWms = L.tileLayer.wms(geoserverBase + '/moj_projekat/wms', Object.assign({
            layers: 'moj_projekat:ndvi_parcela_25991',
            format: 'image/png',
            transparent: true,
            styles: 'index_rgb_style',
            attribution: 'Copernicus Sentinel-2 NDVI'
        }, { updateWhenIdle: true, updateWhenZooming: false }));  // updateWhenIdle smanjuje burst zahteva (429)
        // Ne dodavaj na mapu po defaultu - prikazi kad korisnik izabere parcelu

        // NDVI value raster za parcele (FLOAT32 sirove vrednosti za GetFeatureInfo ‚Äì klik na piksel)
        var ndviValueParcelWms = L.tileLayer.wms(geoserverBase + '/moj_projekat/wms', Object.assign({
            layers: 'moj_projekat:ndvi_value_parcela_25991',
            format: 'image/png',
            transparent: true,
            styles: 'raster',
            attribution: 'Copernicus Sentinel-2 NDVI Value (parcela)'
        }, { updateWhenIdle: true, updateWhenZooming: false }));
        // Value layer je nevidljiv (nije dodat na mapu), koristi se samo za GetFeatureInfo
        
        // NDMI raster za parcele
        var ndmiParcelWms = L.tileLayer.wms(geoserverBase + '/moj_projekat/wms', Object.assign({
            layers: 'moj_projekat:ndmi_parcela_25991',
            format: 'image/png',
            transparent: true,
            styles: 'index_rgb_style',
            attribution: 'Copernicus Sentinel-2 NDMI (parcela)'
        }, { updateWhenIdle: true, updateWhenZooming: false }));
        ndmiParcelWms.setOpacity(0); // Poƒçetna transparentnost 0 (nevidljivo) - ne dodaje se na mapu po defaultu
        
        // NDRE raster za parcele
        var ndreParcelWms = L.tileLayer.wms(geoserverBase + '/moj_projekat/wms', Object.assign({
            layers: 'moj_projekat:ndre_parcela_25991',
            format: 'image/png',
            transparent: true,
            styles: 'index_rgb_style',
            attribution: 'Copernicus Sentinel-2 NDRE (parcela)'
        }, { updateWhenIdle: true, updateWhenZooming: false }));
        ndreParcelWms.setOpacity(0); // Poƒçetna transparentnost 0 (nevidljivo) - ne dodaje se na mapu po defaultu
        
        // NDRE value raster za parcele (FLOAT32 sirove vrednosti za GetFeatureInfo)
        var ndreValueParcelWms = L.tileLayer.wms(geoserverBase + '/moj_projekat/wms', Object.assign({
            layers: 'moj_projekat:ndre_value_parcela_25991',
            format: 'image/png',
            transparent: true,
            styles: 'raster',
            attribution: 'Copernicus Sentinel-2 NDRE Value (parcela)'
        }, { updateWhenIdle: true, updateWhenZooming: false }));
        // Value layer je nevidljiv (nije dodat na mapu), koristi se samo za GetFeatureInfo
        
        // NDRE zones raster (crvena/≈æuta/zelena) - layer name se postavlja u setNdreZonesLayerForParcel
        var ndreZonesParcelWms = L.tileLayer.wms(geoserverBase + '/moj_projekat/wms', Object.assign({
            layers: 'moj_projekat:ndre_zones_parcela_25991',
            format: 'image/png',
            transparent: true,
            styles: 'ndre_zones_style',
            version: '1.1.1',
            attribution: 'Copernicus Sentinel-2 NDRE Zone'
        }, { updateWhenIdle: true, updateWhenZooming: false }));
        ndreZonesParcelWms.on('tileerror', function(ev) {
            console.error('NDRE zones WMS tile gre≈°ka:', ev.tile?.src || ev);
        });
        ndreZonesParcelWms.setOpacity(0); // Poƒçetna transparentnost 0 (nevidljivo) - ne dodaje se na mapu po defaultu
        
        // Dodaj slojeve za parcele u layerControl (registruj za a≈æuriranje pri promeni jezika)
        parcelOverlayRegistry.push({ layer: ndviWms, key: "ndvi_parcela" });
        parcelOverlayRegistry.push({ layer: ndmiParcelWms, key: "ndmi_parcela" });
        parcelOverlayRegistry.push({ layer: ndreParcelWms, key: "ndre_parcela" });
        parcelOverlayRegistry.push({ layer: ndreZonesParcelWms, key: "ndre_zone_parcela" });
        layerControl.addOverlay(ndviWms, t("ndvi_parcela"));
        layerControl.addOverlay(ndmiParcelWms, t("ndmi_parcela"));
        layerControl.addOverlay(ndreParcelWms, t("ndre_parcela"));
        layerControl.addOverlay(ndreZonesParcelWms, t("ndre_zone_parcela"));

        // WMTS (GeoWebCache) ‚Äì ke≈°irani tile-ovi, ~80% manje optereƒáenja od ƒçistog WMS
        function wmtsTileUrl(base, layer) {
            return base + '/gwc/service/wmts?layer=' + encodeURIComponent(layer) +
                '&style=&tilematrixset=EPSG:900913&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/png' +
                '&TileMatrix={z}&TileRow={y}&TileCol={x}';
        }
        var ndmiWms = L.tileLayer(wmtsTileUrl(geoserverBase, 'moj_projekat:ndmi_srbija'), {
            attribution: 'Copernicus Sentinel-2 NDMI'
        });
        var ndreWms = L.tileLayer(wmtsTileUrl(geoserverBase, 'moj_projekat:ndre_srbija'), {
            attribution: 'Copernicus Sentinel-2 NDRE'
        });
        var eviWms = L.tileLayer(wmtsTileUrl(geoserverBase, 'moj_projekat:evi_srbija'), {
            attribution: 'Copernicus Sentinel-2 EVI'
        });
        var droughtWms = L.tileLayer(wmtsTileUrl(geoserverBase, 'moj_projekat:drought_zones'), {
            attribution: 'Drought stress zones (NDMI)'
        });


        function normalizeOverlayOrder() {
            var container = layerControl && layerControl._container;
            if (!container) {
                return;
            }
            var overlays = container.querySelector(".leaflet-control-layers-overlays");
            if (!overlays) {
                return;
            }

            function findLabelExact(text) {
                var labels = overlays.querySelectorAll("label");
                var match = null;
                labels.forEach(function(label) {
                    if (label.textContent && label.textContent.trim() === text) {
                        match = label;
                    }
                });
                return match;
            }

            function moveLabelAndSlider(labelText, sliderId) {
                var label = findLabelExact(labelText);
                if (!label) {
                    return;
                }
                overlays.appendChild(label);
                if (sliderId) {
                    var slider = document.getElementById(sliderId);
                    if (slider) {
                        overlays.appendChild(slider.parentNode);
                    }
                }
            }

        }

        // 5. Skala
        L.control.scale().addTo(map);
        
        // 6. Meraƒç (ruler) za merenje parcela - jednostavan custom ruler
        var isMeasuring = false;
        var measurePoints = [];
        var measureLayer = L.layerGroup().addTo(map);
        var measureLine = null;
        var measurePolygon = null;
        
        var measureControl = L.control({
            position: 'topleft'
        });
        
        measureControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
            div.innerHTML = '<a href="#" role="button" title="' + t("meri_tooltip") + '" style="width:30px;height:30px;line-height:30px;display:block;text-align:center;text-decoration:none;font-weight:bold;font-size:18px;">üìè</a>';
            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.on(div, 'click', function(e) {
                L.DomEvent.stopPropagation(e);
                L.DomEvent.preventDefault(e);
                if (!isMeasuring) {
                    isMeasuring = true;
                    measurePoints = [];
                    if (measureLine && measureLine.closeTooltip) measureLine.closeTooltip();
                    measureLine = null;
                    measurePolygon = null;
                    measureLayer.clearLayers();
                    map.on('click', measureOnClick);
                    div.querySelector('a').style.backgroundColor = '#2c7be5';
                    div.querySelector('a').style.color = '#fff';
                } else {
                    isMeasuring = false;
                    map.off('click', measureOnClick);
                    div.querySelector('a').style.backgroundColor = '';
                    div.querySelector('a').style.color = '';
                    if (measurePoints.length > 0) {
                        measurePoints = [];
                        measureLayer.clearLayers();
                    }
                }
            });
            return div;
        };
        
        function measureOnClick(e) {
            measurePoints.push(e.latlng);
            
            if (measurePoints.length === 1) {
                // Prva taƒçka - marker
                L.marker(e.latlng).addTo(measureLayer);
            } else if (measurePoints.length === 2) {
                // Druga taƒçka - linija + trajna oznaka du≈æine na liniji
                measureLine = L.polyline(measurePoints, {color: '#2c7be5', weight: 3}).addTo(measureLayer);
                var distance = measurePoints[0].distanceTo(measurePoints[1]);
                var lengthText = t("length_label") + ' ' + distance.toFixed(2) + ' m (' + (distance/1000).toFixed(3) + ' km)';
                var mid = measureLine.getBounds().getCenter();
                measureLine.bindTooltip(lengthText, { permanent: true, direction: 'center', className: 'measure-length-tooltip', offset: [0, 0] }).openTooltip(mid);
            } else {
                // Vi≈°e taƒçaka - poligon; zatvori tooltip na staroj liniji pre uklanjanja
                if (measureLine) {
                    if (measureLine.closeTooltip) measureLine.closeTooltip();
                    measureLayer.removeLayer(measureLine);
                    measureLine = null;
                }
                measurePolygon = L.polygon(measurePoints, {color: '#2c7be5', weight: 3, fillOpacity: 0.3}).addTo(measureLayer);
                var area = L.GeometryUtil.geodesicArea(measurePoints);
                var segmentLengthsText = L.GeometryUtil.segmentLengths(measurePoints);
                var popupContent = t("area_m2") + ' ' + area.toFixed(2) + ' m¬≤ (' + (area/10000).toFixed(3) + ' ha)';
                if (segmentLengthsText) popupContent += '<br>' + segmentLengthsText;
                var popup = L.popup().setLatLng(e.latlng).setContent(popupContent).openOn(map);
            }
        }
        
        // Helper za izraƒçunavanje povr≈°ine (geodetski taƒçno) i dimenzija
        L.GeometryUtil = {
            // Povr≈°ina u m¬≤ ‚Äì koristi srednju geografsku ≈°irinu za taƒçan stepen->m (lon zavisi od lat)
            geodesicArea: function(latlngs) {
                if (!latlngs || latlngs.length < 3) return 0;
                var area = 0;
                for (var i = 0; i < latlngs.length; i++) {
                    var j = (i + 1) % latlngs.length;
                    area += latlngs[i].lng * latlngs[j].lat;
                    area -= latlngs[j].lng * latlngs[i].lat;
                }
                area = Math.abs(area) / 2;
                var latMid = latlngs.reduce(function(s, p) { return s + p.lat; }, 0) / latlngs.length;
                var mPerDegLat = 111320;
                var mPerDegLon = 111320 * Math.cos(latMid * Math.PI / 180);
                return area * mPerDegLat * mPerDegLon;
            },
            // Du≈æine stranica: 1‚Üí2, 2‚Üí3, ‚Ä¶ (u metrima)
            segmentLengths: function(latlngs) {
                if (!latlngs || latlngs.length < 2) return '';
                var parts = [];
                for (var i = 0; i < latlngs.length; i++) {
                    var j = (i + 1) % latlngs.length;
                    var d = latlngs[i].distanceTo(latlngs[j]);
                    parts.push((i + 1) + '‚Üí' + (j + 1) + ': ' + d.toFixed(2) + ' m');
                }
                return (t("sides_lengths_label") || "Du≈æine stranica:") + '<br>' + parts.join(', ');
            }
        };
        
        measureControl.addTo(map);

        // Kontrola za otvaranje grafikona u overlay-u (gornja polovina ekrana)
        var chartOverlayControl = L.control({ position: 'topleft' });
        chartOverlayControl.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-chart-btn');
            div.innerHTML = '<a href="#" role="button" title="' + t("chart_tooltip") + '">üìà</a>';
            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.on(div, 'click', function(e) {
                L.DomEvent.stop(e);
                var overlay = document.getElementById("chartOverlay");
                if (overlay && !overlay.classList.contains("visible")) {
                    overlay.classList.add("visible");
                    if (Object.keys(allCsvData).length > 0) {
                        updateTimeChart("timeChartOverlayCanvas");
                    }
                }
            });
            return div;
        };
        chartOverlayControl.addTo(map);

        // Zatvaranje overlay-a za grafikon
        (function() {
            var closeBtn = document.getElementById("chartOverlayClose");
            var overlay = document.getElementById("chartOverlay");
            if (closeBtn && overlay) {
                closeBtn.addEventListener("click", function() {
                    overlay.classList.remove("visible");
                    if (timeChartOverlay !== null) {
                        timeChartOverlay.destroy();
                        timeChartOverlay = null;
                    }
                });
            }
        })();

        // Download statistike za poslednjih 5 godina
        function downloadChartDataCsv() {
            var parcelId = (currentParcelId || (document.getElementById("parcelInput") && document.getElementById("parcelInput").value) || "parcela").replace(/[/\\]/g, "_");
            var cutoffDate = new Date(Date.now() - currentTimeRange * 24 * 60 * 60 * 1000);
            var rows = [];
            ["NDVI", "NDMI", "NDRE"].forEach(function(indexName) {
                var data = allCsvData[indexName] || [];
                data.filter(function(row) {
                    try {
                        var d = new Date(row.date);
                        return d >= cutoffDate && row.mean !== null && !isNaN(row.mean);
                    } catch (e) { return false; }
                }).sort(function(a, b) { return new Date(a.date) - new Date(b.date); }).forEach(function(row) {
                    var dateStr = row.date ? (row.date.indexOf("T") >= 0 ? row.date.split("T")[0] : row.date) : "";
                    rows.push([dateStr, indexName, (row.mean != null ? row.mean.toFixed(4) : ""), (row.min != null ? row.min.toFixed(4) : ""), (row.max != null ? row.max.toFixed(4) : ""), (row.median != null ? row.median.toFixed(4) : "")]);
                });
            });
            if (rows.length === 0) {
                alert(t("no_data_download"));
                return;
            }
            var csvHeader = "Datum,Indeks,Mean,Min,Max,Median\n";
            var csvBody = rows.map(function(r) { return r.join(","); }).join("\n");
            var blob = new Blob(["\ufeff" + csvHeader + csvBody], { type: "text/csv;charset=utf-8" });
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "statistika_5godina_" + parcelId + ".csv";
            a.click();
            URL.revokeObjectURL(a.href);
        }
        (function() {
            var dlBtn = document.getElementById("chartOverlayDownload");
            if (dlBtn) dlBtn.addEventListener("click", downloadChartDataCsv);
        })();

        // 6. Dinamiƒçki datum snimaka
        (function updateMetadata() {
            var metaBar = document.getElementById("metaBar");
            if (!metaBar) {
                return;
            }
            var metaUrl = "ndvi_auto/latest_metadata.json?ts=" + Date.now();
            fetch(metaUrl)
                .then(function(response) { return response.json(); })
                .then(function(meta) {
                    function line(label, data) {
                        if (!data || !data.from || !data.to) {
                            return label + ": n/a";
                        }
                        var fb = data.fallback ? " (fallback)" : "";
                        return label + ": " + data.from + " ‚Üí " + data.to + fb;
                    }
                    var html = [
                        "<div><strong>Satelitski snimci</strong></div>",
                        "<div>" + line("NDVI", meta.ndvi) + "</div>",
                        "<div>" + line("NDMI", meta.ndmi) + "</div>",
                        "<div>" + line("NDRE", meta.ndre) + "</div>",
                        "<div>" + line("EVI", meta.evi) + "</div>",
                        "<div>" + line("Su≈°a", meta.drought) + "</div>"
                    ].join("");
                    metaBar.innerHTML = html;
                    metaBar.style.display = "block";
                })
                .catch(function() {
                    metaBar.style.display = "none";
                });
        })();

        function toNumber(value) {
            if (value === "" || value === undefined || value === null) return null;
            var n = Number(value);
            return Number.isFinite(n) ? n : null;
        }
        function parseCsv(text) {
            if (!text || !text.trim()) {
                return [];
            }
            var lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) {
                return [];
            }
            var headers = lines[0].split(",").map(function(h) { return h.trim(); });
            return lines.slice(1).filter(function(line) {
                return line.trim().length > 0; // Filtriraj prazne redove
            }).map(function(line) {
                var cols = line.split(",");
                var row = {};
                headers.forEach(function(key, idx) {
                    row[key] = cols[idx] !== undefined ? cols[idx].trim() : "";
                });
                return row;
            });
        }
        function pickLatestGood(rows) {
            var good = rows.filter(function(row) {
                var mean = toNumber(row["C0/mean"]);
                if (mean === null) return false;  // Bez validnih statistiƒçkih podataka (npr. 100% oblaka)
                var cloud = toNumber(row["C0/cloudCoveragePercent"]);
                return cloud === null ? true : cloud < 80;
            });
            if (!good.length) {
                return null;
            }
            good.sort(function(a, b) {
                return new Date(a["C0/date"]).getTime() - new Date(b["C0/date"]).getTime();
            });
            // Pronaƒëi prethodni validan podatak (ne prvi u intervalu)
            var latest = good[good.length - 1];
            var previous = good.length > 1 ? good[good.length - 2] : null;
            return { 
                first: good[0], 
                latest: latest,
                previous: previous,  // Prethodni validan podatak
                validCount: good.length,
                totalCount: rows.length
            };
        }
        function trendText(firstVal, lastVal) {
            if (firstVal === null || lastVal === null) {
                return "n/a";
            }
            var diff = lastVal - firstVal;
            if (Math.abs(diff) < 0.03) {
                return "stabilno";
            }
            return diff > 0 ? "u porastu" : "u padu";
        }
        function extractPeriodFromPath(path) {
            var match = path.match(/NDVI-([0-9-:TZ_.]+)-([0-9-:TZ_.]+)\.csv/i);
            if (!match) {
                return null;
            }
            return match[1].replace(/_/g, ":") + " ‚Üí " + match[2].replace(/_/g, ":");
        }
        var currentParcelId = null;
        var lastCsvError = null;
        var timeChart = null;
        var timeChartOverlay = null;
        var currentTimeRange = 1825; // dani (5 godina) - za grafikon
        var reportPanelDays = 30;   // u desnom panelu prika≈æi validne rezultate samo za poslednjih 30 dana
        var allCsvData = {}; // {NDVI: [...], NDMI: [...], NDRE: [...]}
        var parcelCsvRows = {}; // sirovi redovi iz API-ja (payload.csv) da buildAutoReport ne mora da fetuje
        var _autoReportVersion = 0;
        function setCurrentParcel(parcelId) {
            currentParcelId = parcelId;
            allCsvData = {};
            parcelCsvRows = {};
            var reportEl = document.getElementById("autoReport");
            if (reportEl) {
                reportEl.innerHTML = "<div><strong>" + t("auto_report") + "</strong><br>" + t("parcel_label") + " " + parcelId + "<br>" + t("cekam_csv") + "</div>";
                reportEl.style.display = "block";
            }
            var chartContainer = document.getElementById("timeChartContainer");
            if (chartContainer) {
                chartContainer.style.display = "none";
            }
        }
        function buildParcelCsvCandidates(parcelId, kind, indexName) {
            var base = "satelite/";
            var list = [];
            if (!parcelId) {
                return list;
            }
            var safeId = getParcelLayerSuffix(parcelId);
            var safeIdNoKo = (parcelId || "").replace(/\//g, "_").replace(/\\/g, "_");
            var index = indexName || "NDVI";
            var indexLower = index.toLowerCase();
            var csvFile = "parcela_" + safeId + "_" + index + ".csv";
            var csvFileAlt = "parcel_" + safeId + "_" + index + ".csv";
            var csvFileAlt2 = indexLower + "_parcela_" + safeId + ".csv";
            var csvFileAlt3 = safeId + "_" + index + ".csv";
            if (typeof parcelServerUrl === "string" && parcelServerUrl) {
                list.push(parcelServerUrl + "/csv_file?file=" + encodeURIComponent(csvFile));
                list.push(parcelServerUrl + "/csv_file?file=" + encodeURIComponent(csvFileAlt));
                list.push(parcelServerUrl + "/csv_file?file=" + encodeURIComponent(csvFileAlt2));
                list.push(parcelServerUrl + "/csv_file?file=" + encodeURIComponent(csvFileAlt3));
            }
            list.push(base + csvFile);
            list.push(base + csvFileAlt);
            list.push(base + csvFileAlt2);
            list.push(base + csvFileAlt3);
            if (safeIdNoKo !== safeId) {
                if (typeof parcelServerUrl === "string" && parcelServerUrl) {
                    list.push(parcelServerUrl + "/csv_file?file=" + encodeURIComponent("parcela_" + safeIdNoKo + "_" + index + ".csv"));
                }
                list.push(base + "parcela_" + safeIdNoKo + "_" + index + ".csv");
            }
            if (kind === "point") {
                list.push(base + "point_" + safeId + "_" + index + ".csv");
                list.push(base + "tacka_" + safeId + "_" + index + ".csv");
            }
            return list;
        }
        function withCacheBust(path) {
            var sep = path.indexOf("?") === -1 ? "?" : "&";
            return path + sep + "ts=" + Date.now();
        }
        function fetchFirstCsv(paths) {
            var index = 0;
            function next() {
                if (index >= paths.length) {
                    return Promise.reject(new Error("not found"));
                }
                var path = paths[index++];
                return fetch(encodeURI(withCacheBust(path)))
                    .then(function(resp) {
                        if (!resp.ok) {
                            throw new Error("not found");
                        }
                        return resp.text().then(function(text) {
                            return { path: path, text: text };
                        });
                    })
                    .catch(next);
            }
            return next();
        }
        function buildAutoReport() {
            var myVersion = ++_autoReportVersion;
            var reportEl = document.getElementById("autoReport");
            var parcelId = currentParcelId || document.getElementById("parcelInput").value.trim();
            var sources = [];
            if (parcelId) {
                sources = [
                    { label: t("ndvi_parcela"), index: "NDVI", candidates: buildParcelCsvCandidates(parcelId, "parcel", "NDVI") },
                    { label: t("ndmi_parcela"), index: "NDMI", candidates: buildParcelCsvCandidates(parcelId, "parcel", "NDMI") },
                    { label: t("ndre_parcela"), index: "NDRE", candidates: buildParcelCsvCandidates(parcelId, "parcel", "NDRE") }
                ];
            } else {
                sources = [];
            }
            var blockByIndex = {};
            var pending = sources.length;
            if (sources.length === 0) {
                var rEl = document.getElementById("autoReport");
                if (rEl) rEl.innerHTML = "<p>" + t("select_parcel_stats") + "</p>";
                return;
            }
            sources.forEach(function(src) {
                var dataPromise = (parcelCsvRows[src.index] && parcelCsvRows[src.index].length > 0)
                    ? Promise.resolve({ path: "api", text: "", rows: parcelCsvRows[src.index] })
                    : fetchFirstCsv(src.candidates || []).then(function(result) {
                        return { path: result.path, text: result.text, rows: parseCsv(result.text) };
                    });
                dataPromise
                    .then(function(data) {
                        var rows = data.rows;
                        
                        // Saƒçuvaj podatke za grafikon (iz fetch-a; iz API-ja veƒá imamo u allCsvData)
                        if (parcelId && rows.length > 0 && !(parcelCsvRows[src.index] && parcelCsvRows[src.index].length > 0)) {
                            allCsvData[src.index] = rows.map(function(row) {
                                return {
                                    date: row["C0/date"],
                                    mean: toNumber(row["C0/mean"]),
                                    min: toNumber(row["C0/min"]),
                                    max: toNumber(row["C0/max"]),
                                    median: toNumber(row["C0/median"]),
                                    cloud: toNumber(row["C0/cloudCoveragePercent"])
                                };
                            }).filter(function(row) {
                                return row.date && row.mean !== null;
                            });
                        }
                        
                        var idxLabel = src.index || "NDVI";
                        var picked = pickLatestGood(rows);
                        var latest, previous, mean, median, p10, p90, min, max, previousMean, latestDate, period;
                        var textParts = [];
                        
                        if (parcelId) {
                            textParts.push(t("parcel_label") + " " + parcelId);
                        }
                        
                        // Za NDMI i NDRE - prika≈æi validne rezultate za poslednjih 30 dana
                        if (idxLabel !== "NDVI") {
                            var cutoffReport = new Date(Date.now() - reportPanelDays * 24 * 60 * 60 * 1000);
                            var allRows = rows.filter(function(row) {
                                return row["C0/date"] && toNumber(row["C0/mean"]) !== null;
                            });
                            allRows.sort(function(a, b) {
                                return new Date(b["C0/date"]).getTime() - new Date(a["C0/date"]).getTime();
                            });
                            var allRowsPanel = allRows.filter(function(row) {
                                return new Date(row["C0/date"]) >= cutoffReport;
                            });
                            textParts.push(t("total_csv_data") + " " + rows.length + ". " + t("total_csv_shown") + " " + reportPanelDays + " " + t("days_unit") + " " + allRowsPanel.length);
                            textParts.push("---");
                            
                            if (allRowsPanel.length > 0) {
                                textParts.push("<strong>" + t("last_days_1") + " " + reportPanelDays + " " + t("last_days_2") + "</strong>");
                                allRowsPanel.forEach(function(row, idx) {
                                    var rowDate = row["C0/date"];
                                    var rowMean = toNumber(row["C0/mean"]);
                                    var rowMedian = toNumber(row["C0/median"]);
                                    var rowMin = toNumber(row["C0/min"]);
                                    var rowMax = toNumber(row["C0/max"]);
                                    var rowP10 = toNumber(row["C0/p10"]);
                                    var rowP90 = toNumber(row["C0/p90"]);
                                    var rowSampleCount = toNumber(row["C0/sampleCount"]);
                                    var rowNoDataCount = toNumber(row["C0/noDataCount"]) || 0;
                                    var validni = (rowSampleCount !== null) ? (rowSampleCount - rowNoDataCount) : null;
                                    
                                    var dateStr = rowDate ? new Date(rowDate).toLocaleDateString("sr-RS") : "N/A";
                                    var dateTimeStr = rowDate ? new Date(rowDate).toLocaleString("sr-RS") : "N/A";
                                    
                                    textParts.push((idx + 1) + ". " + dateStr + " (" + dateTimeStr + ")");
                                    if (rowMean !== null) {
                                        var interpretation = "";
                                        if (idxLabel === "NDMI") interpretation = interpretNdmi(rowMean);
                                        else if (idxLabel === "NDRE") interpretation = interpretNdre(rowMean);
                                        textParts.push("   " + idxLabel + " Mean: " + rowMean.toFixed(3) + " (" + interpretation + ")");
                                    } else {
                                        textParts.push("   " + idxLabel + " Mean: N/A (oblaci)");
                                    }
                                    if (rowMedian !== null) textParts.push("   Median: " + rowMedian.toFixed(3));
                                    if (rowMin !== null && rowMax !== null) {
                                        textParts.push("   " + t("min_label") + " " + rowMin.toFixed(3) + ", " + t("max_label") + " " + rowMax.toFixed(3));
                                        if (idxLabel === "NDRE") {
                                            textParts.push("   " + t("min_zone_label") + " " + getNdreZone(rowMin) + ", " + t("max_zone_label") + " " + getNdreZone(rowMax));
                                            textParts.push("   Raspon: " + (rowMax - rowMin).toFixed(3));
                                        }
                                    }
                                    if (rowP10 !== null && rowP90 !== null) textParts.push("   p10/p90: " + rowP10.toFixed(3) + " / " + rowP90.toFixed(3));
                                    if (validni !== null) textParts.push("   " + t("valid_pixels_label") + " " + validni);
                                    if (rowNoDataCount > 0) textParts.push("   " + t("pixels_clouds") + " " + rowNoDataCount);
                                    textParts.push("");
                                });
                            } else {
                                if (allRows.length === 0) {
                                    textParts.push("CSV fajl je prazan (nema podataka).");
                                    textParts.push(t("error_reasons"));
                                } else {
                                    textParts.push(t("no_valid_data") + " " + reportPanelDays + " " + t("days_suffix"));
                                    var latestRow = allRows[0];
                                    var latestMean = toNumber(latestRow["C0/mean"]);
                                    var latestMin = toNumber(latestRow["C0/min"]);
                                    var latestMax = toNumber(latestRow["C0/max"]);
                                    var latestMedian = toNumber(latestRow["C0/median"]);
                                    var prevRow = allRows[1];
                                    var prevMean = prevRow ? toNumber(prevRow["C0/mean"]) : null;
                                    if (latestRow && latestMean !== null) {
                                        textParts.push("<strong>Najnoviji validan podatak:</strong>");
                                        textParts.push(t("snapshot_label") + " " + (latestRow["C0/date"] || ""));
                                        textParts.push(idxLabel + " mean: " + latestMean.toFixed(3) + " (" + (idxLabel === "NDMI" ? interpretNdmi(latestMean) : interpretNdre(latestMean)) + ")");
                                        if (latestMin !== null && latestMax !== null) {
                                            if (idxLabel === "NDRE") {
                                                textParts.push(t("min_label") + " " + latestMin.toFixed(3) + " (" + getNdreZone(latestMin) + ")");
                                                textParts.push(t("max_label") + " " + latestMax.toFixed(3) + " (" + getNdreZone(latestMax) + ")");
                                                textParts.push("Raspon: " + (latestMax - latestMin).toFixed(3));
                                            } else {
                                                textParts.push(t("min_label") + " " + latestMin.toFixed(3) + ", " + t("max_label") + " " + latestMax.toFixed(3));
                                            }
                                        }
                                        if (latestMedian !== null) textParts.push("median: " + latestMedian.toFixed(3));
                                        textParts.push(t("trend_label") + " " + trendText(prevMean, latestMean));
                                    }
                                }
                            }
                            blockByIndex[src.index] = { label: src.label, content: textParts.join("<br>") };
                            if (idxLabel === "NDRE" && allRowsPanel.length > 0) {
                                var firstNdre = allRowsPanel[0];
                                var isoDate = firstNdre["C0/date"] ? String(firstNdre["C0/date"]).split("T")[0] : null;
                                if (isoDate && window.setParcelImageDate) window.setParcelImageDate(isoDate);
                            }
                            return;
                        }
                        
                        // Za NDVI - posebna logika (prikaz samo poslednjih 30 dana)
                        if (!picked) {
                            var cutoffReportNdvi = new Date(Date.now() - reportPanelDays * 24 * 60 * 60 * 1000);
                            var allRowsNdvi = rows.filter(function(row) {
                                return row["C0/date"] && toNumber(row["C0/mean"]) !== null;
                            });
                            allRowsNdvi.sort(function(a, b) {
                                return new Date(b["C0/date"]).getTime() - new Date(a["C0/date"]).getTime();
                            });
                            var allRowsNdviPanel = allRowsNdvi.filter(function(row) {
                                return new Date(row["C0/date"]) >= cutoffReportNdvi;
                            });
                            textParts.push(t("total_csv_data") + " " + rows.length + ". " + t("total_csv_shown") + " " + reportPanelDays + " " + t("days_unit") + " " + allRowsNdviPanel.length);
                            textParts.push("---");
                            
                            if (allRowsNdvi.length > 0) {
                                var goodForLayer = allRowsNdvi.filter(function(r) { return toNumber(r["C0/mean"]) !== null; });
                                if (goodForLayer.length > 0) {
                                    var first = allRowsNdvi.find(function(r) { return toNumber(r["C0/mean"]) !== null; });
                                    if (first) setNdviLayerForParcel(parcelId, new Date(first["C0/date"]).toISOString().split('T')[0]);
                                }
                                if (allRowsNdviPanel.length > 0) {
                                    textParts.push("<strong>" + t("last_days_1") + " " + reportPanelDays + " " + t("last_days_2") + "</strong>");
                                    allRowsNdviPanel.forEach(function(row, idx) {
                                    var rowDate = row["C0/date"];
                                    var rowMean = toNumber(row["C0/mean"]);
                                    var rowMedian = toNumber(row["C0/median"]);
                                    var rowMin = toNumber(row["C0/min"]);
                                    var rowMax = toNumber(row["C0/max"]);
                                    var rowSampleCount = toNumber(row["C0/sampleCount"]);
                                    var rowNoDataCount = toNumber(row["C0/noDataCount"]) || 0;
                                    var validni = (rowSampleCount !== null) ? (rowSampleCount - rowNoDataCount) : null;
                                    
                                    var dateStr = rowDate ? new Date(rowDate).toLocaleDateString("sr-RS") : "N/A";
                                    var dateTimeStr = rowDate ? new Date(rowDate).toLocaleString("sr-RS") : "N/A";
                                    
                                    textParts.push((idx + 1) + ". " + dateStr + " (" + dateTimeStr + ")");
                                    if (rowMean !== null) {
                                        textParts.push("   " + t("ndvi_mean_label") + " " + rowMean.toFixed(3) + " (" + interpretNdvi(rowMean) + ")");
                                    } else {
                                        textParts.push("   " + t("ndvi_mean_clouds"));
                                    }
                                    if (rowMedian !== null) textParts.push("   Median: " + rowMedian.toFixed(3));
                                    if (rowMin !== null && rowMax !== null) textParts.push("   " + t("min_label") + " " + rowMin.toFixed(3) + ", " + t("max_label") + " " + rowMax.toFixed(3));
                                    if (validni !== null) textParts.push("   " + t("valid_pixels_label") + " " + validni);
                                    if (rowNoDataCount > 0) textParts.push("   " + t("pixels_clouds") + " " + rowNoDataCount);
                                    textParts.push("");
                                    });
                                } else {
                                    textParts.push(t("no_valid_data") + " " + reportPanelDays + " " + t("days_suffix"));
                                }
                            } else {
                                textParts.push("CSV fajl je prazan (nema podataka).");
                            }
                            blockByIndex[src.index] = { label: src.label, content: textParts.join("<br>") };
                            return;
                        }
                        
                        latest = picked.latest;
                        previous = picked.previous;
                        mean = toNumber(latest["C0/mean"]);
                        median = toNumber(latest["C0/median"]);
                        p10 = toNumber(latest["C0/p10"]);
                        p90 = toNumber(latest["C0/p90"]);
                        min = toNumber(latest["C0/min"]);
                        max = toNumber(latest["C0/max"]);
                        previousMean = previous ? toNumber(previous["C0/mean"]) : null;
                        latestDate = latest["C0/date"];
                        period = extractPeriodFromPath(data.path);
                        textParts = [];
                        if (parcelId) {
                            textParts.push(t("parcel_label") + " " + parcelId);
                        }
                        // Prika≈æi ukupan broj podataka i broj validnih
                        var totalRows = picked.totalCount || rows.length;
                        var validRows = picked.validCount || 0;
                        textParts.push(t("total_csv_data") + " " + totalRows + " (" + t("valid_in_count") + " " + validRows + ")");
                        textParts.push("---");
                        
                        // Za NDVI prika≈æi validne rezultate za poslednjih 30 dana
                        if (idxLabel === "NDVI") {
                            var cutoffReportNdvi2 = new Date(Date.now() - reportPanelDays * 24 * 60 * 60 * 1000);
                            var allRowsNdvi = rows.filter(function(row) {
                                return row["C0/date"] && toNumber(row["C0/mean"]) !== null;
                            });
                            allRowsNdvi.sort(function(a, b) {
                                return new Date(b["C0/date"]).getTime() - new Date(a["C0/date"]).getTime();
                            });
                            var allRowsNdviPanel2 = allRowsNdvi.filter(function(row) {
                                return new Date(row["C0/date"]) >= cutoffReportNdvi2;
                            });
                            if (allRowsNdvi.length > 0) {
                                var firstValid = allRowsNdvi.find(function(r) { return toNumber(r["C0/mean"]) !== null; });
                                if (firstValid) setNdviLayerForParcel(parcelId, new Date(firstValid["C0/date"]).toISOString().split('T')[0]);
                                if (allRowsNdviPanel2.length > 0) {
                                    textParts.push("<strong>" + t("last_days_1") + " " + reportPanelDays + " " + t("last_days_2") + "</strong>");
                                    allRowsNdviPanel2.forEach(function(row, idx) {
                                    var rowDate = row["C0/date"];
                                    var rowMean = toNumber(row["C0/mean"]);
                                    var rowMedian = toNumber(row["C0/median"]);
                                    var rowMin = toNumber(row["C0/min"]);
                                    var rowMax = toNumber(row["C0/max"]);
                                    var rowSampleCount = toNumber(row["C0/sampleCount"]);
                                    var rowNoDataCount = toNumber(row["C0/noDataCount"]) || 0;
                                    var validni = (rowSampleCount !== null) ? (rowSampleCount - rowNoDataCount) : null;
                                    
                                    var dateStr = rowDate ? new Date(rowDate).toLocaleDateString("sr-RS") : "N/A";
                                    var dateTimeStr = rowDate ? new Date(rowDate).toLocaleString("sr-RS") : "N/A";
                                    
                                    textParts.push((idx + 1) + ". " + dateStr + " (" + dateTimeStr + ")");
                                    if (rowMean !== null) {
                                        textParts.push("   " + t("ndvi_mean_label") + " " + rowMean.toFixed(3) + " (" + interpretNdvi(rowMean) + ")");
                                    } else {
                                        textParts.push("   " + t("ndvi_mean_clouds"));
                                    }
                                    if (rowMedian !== null) textParts.push("   Median: " + rowMedian.toFixed(3));
                                    if (rowMin !== null && rowMax !== null) textParts.push("   " + t("min_label") + " " + rowMin.toFixed(3) + ", " + t("max_label") + " " + rowMax.toFixed(3));
                                    if (validni !== null) textParts.push("   " + t("valid_pixels_label") + " " + validni);
                                    if (rowNoDataCount > 0) textParts.push("   " + t("pixels_clouds") + " " + rowNoDataCount);
                                    textParts.push("");
                                });
                            } else {
                                // Fallback ako nema podataka
                                textParts.push("<strong>Najnoviji validan podatak:</strong>");
                                textParts.push(t("snapshot_label") + " " + latestDate);
                                if (period) {
                                    textParts.push("Period fajla: " + period);
                                }
                                if (mean !== null) {
                                    textParts.push(t("ndvi_mean_simple") + " " + mean.toFixed(3) + " (" + interpretNdvi(mean) + ")");
                                }
                                if (min !== null && max !== null) {
                                    textParts.push(t("min_label") + " " + min.toFixed(3) + ", " + t("max_label") + " " + max.toFixed(3));
                                }
                                if (median !== null) {
                                    textParts.push("median: " + median.toFixed(3));
                                }
                                if (p10 !== null && p90 !== null) {
                                    textParts.push("p10/p90: " + p10.toFixed(3) + " / " + p90.toFixed(3));
                                }
                                textParts.push(t("trend_label") + " " + trendText(previousMean, mean));
                            }
                            }
                        } else {
                            // Za NDMI i NDRE - originalna logika (samo najnoviji podatak)
                            textParts.push("<strong>Najnoviji validan podatak:</strong>");
                            textParts.push(t("snapshot_label") + " " + latestDate);
                            if (period) {
                                textParts.push("Period fajla: " + period);
                            }
                            if (mean !== null) {
                                var interpretation = "";
                                if (idxLabel === "NDMI") {
                                    interpretation = interpretNdmi(mean);
                                } else if (idxLabel === "NDRE") {
                                    interpretation = interpretNdre(mean);
                                }
                                textParts.push(idxLabel + " mean: " + mean.toFixed(3) + " (" + interpretation + ")");
                            }
                            // Za NDRE, prika≈æi min, max i zone; za NDMI samo min, max
                            if (idxLabel === "NDRE" && min !== null && max !== null) {
                                textParts.push(t("min_label") + " " + min.toFixed(3) + " (" + getNdreZone(min) + ")");
                                textParts.push(t("max_label") + " " + max.toFixed(3) + " (" + getNdreZone(max) + ")");
                                textParts.push("Raspon: " + (max - min).toFixed(3));
                            } else if (idxLabel === "NDMI" && min !== null && max !== null) {
                                textParts.push(t("min_label") + " " + min.toFixed(3) + ", " + t("max_label") + " " + max.toFixed(3));
                            }
                            if (median !== null) {
                                textParts.push("median: " + median.toFixed(3));
                            }
                            if (p10 !== null && p90 !== null) {
                                textParts.push("p10/p90: " + p10.toFixed(3) + " / " + p90.toFixed(3));
                            }
                            // Trend u odnosu na prethodni datum (ne prvi u intervalu)
                            textParts.push(t("trend_label") + " " + trendText(previousMean, mean));
                        }
                        blockByIndex[src.index] = { label: src.label, content: textParts.join("<br>") };
                    })
                    .catch(function() {
                        if (parcelId) {
                            var expected = (src.candidates || []).map(function(p) {
                                var m = p.match(/[?&]file=([^&]+)/);
                                if (m) return decodeURIComponent(m[1]);
                                return p.replace("satelite/", "");
                            });
                            var errorLine = lastCsvError ? "<br>" + t("error_label") + " " + lastCsvError : "";
                            blockByIndex[src.index] = { label: src.label, content: t("expected_files") + " " + expected.join(", ") + errorLine };
                        }
                    })
                    .finally(function() {
                        pending -= 1;
                        if (pending === 0) {
                            if (myVersion !== _autoReportVersion) return;
                            var tabOrder = ["NDVI", "NDMI", "NDRE"];
                            var items = tabOrder.filter(function(idx) { return blockByIndex[idx]; }).map(function(idx) { return blockByIndex[idx]; });
                            if (items.length) {
                                var tabsHtml = '<div class="auto-report-tabs">';
                                var contentHtml = '<div class="auto-report-content">';
                                items.forEach(function(item, i) {
                                    var panelId = "autoReportPanel_" + i;
                                    tabsHtml += '<button type="button" class="auto-report-tab' + (i === 0 ? ' active' : '') + '" data-tab="' + panelId + '">' + item.label + '</button>';
                                    contentHtml += '<div id="' + panelId + '" class="auto-report-panel' + (i === 0 ? ' active' : '') + '">' + item.content + '</div>';
                                });
                                tabsHtml += '</div>';
                                contentHtml += '</div>';
                                reportEl.innerHTML = tabsHtml + contentHtml;
                                reportEl.querySelectorAll(".auto-report-tab").forEach(function(btn) {
                                    btn.addEventListener("click", function() {
                                        reportEl.querySelectorAll(".auto-report-tab").forEach(function(b) { b.classList.remove("active"); });
                                        reportEl.querySelectorAll(".auto-report-panel").forEach(function(p) { p.classList.remove("active"); });
                                        btn.classList.add("active");
                                        var panel = document.getElementById(btn.getAttribute("data-tab"));
                                        if (panel) panel.classList.add("active");
                                    });
                                });
                            } else {
                                reportEl.innerHTML = "<div class=\"auto-report-content\"><p>" + t("no_csv_display") + "</p></div>";
                            }
                            reportEl.style.display = "block";
                            
                            // Prika≈æi grafikon ako ima podataka
                            if (parcelId && Object.keys(allCsvData).length > 0) {
                                var chartContainer = document.getElementById("timeChartContainer");
                                if (chartContainer) {
                                    chartContainer.style.display = "block";
                                    if (timeChart === null) {
                                        updateTimeChart();
                                    } else {
                                        updateTimeChart();
                                    }
                                }
                            } else {
                                var chartContainer = document.getElementById("timeChartContainer");
                                if (chartContainer) {
                                    chartContainer.style.display = "none";
                                }
                            }
                        }
                    });
            });
        }
        setTimeout(buildAutoReport, 0);

        var indexInfo = document.getElementById("indexInfo");
        function showIndexInfo(html) {
            if (!indexInfo) {
                return;
            }
            indexInfo.innerHTML = html;
            indexInfo.style.display = "block";
        }
        function getActiveIndexLayer() {
            // Prioritet: NDVI, NDMI, NDRE, NDRE Zones (redosled u panelu levo)
            // Za GetFeatureInfo koristimo value slojeve (sirove vrednosti), ne RGB
            if (ndviWms && map.hasLayer(ndviWms)) {
                return { layer: ndviValueParcelWms, label: "NDVI" };
            }
            if (ndmiParcelWms && map.hasLayer(ndmiParcelWms)) {
                return { layer: ndmiParcelWms, label: "NDMI" };
            }
            if (ndreParcelWms && map.hasLayer(ndreParcelWms)) {
                if (ndreValueParcelWms) {
                    return { layer: ndreValueParcelWms, label: "NDRE" };
                }
                return { layer: ndreParcelWms, label: "NDRE" };
            }
            if (ndreZonesParcelWms && map.hasLayer(ndreZonesParcelWms)) {
                if (ndreValueParcelWms) {
                    return { layer: ndreValueParcelWms, label: "NDRE Zone", isZones: true };
                }
                return { layer: ndreZonesParcelWms, label: "NDRE Zone", isZones: true };
            }
            return null;
        }
        function getNdreZone(value) {
            if (value === null || Number.isNaN(value)) return t("interp_no_data");
            if (value < 0.14) return t("zone_red");
            if (value < 0.19) return t("zone_yellow");
            return t("zone_green");
        }
        var PARCEL_RASTER_RESOLUTION_M = 10;
        var PARCEL_RASTER_MAX_PIXELS = 2500;
        var parcelValueRasterWidth = null;
        var parcelValueRasterHeight = null;
        var parcelValueRasterWidthNdre = null;
        var parcelValueRasterHeightNdre = null;

        function buildFeatureInfoUrl(layer, latlng, infoFormat, version, useScreenCoords) {
            var wmsVersion = version || "1.1.1";
            var bbox3857, widthPx, heightPx, pixelX, pixelY;
            var isParcelValueLayer = !useScreenCoords && (layer === ndviValueParcelWms || layer === ndreValueParcelWms) && parcelHighlight;
            if (isParcelValueLayer && parcelHighlight.getBounds) {
                var parcelBounds = parcelHighlight.getBounds();
                var sw = parcelBounds.getSouthWest();
                var ne = parcelBounds.getNorthEast();
                var minLon = sw.lng, minLat = sw.lat, maxLon = ne.lng, maxLat = ne.lat;
                var sw3857 = map.options.crs.project(sw);
                var ne3857 = map.options.crs.project(ne);
                bbox3857 = [sw3857.x, sw3857.y, ne3857.x, ne3857.y];
                var useNdreDims = (layer === ndreValueParcelWms) && parcelValueRasterWidthNdre != null && parcelValueRasterHeightNdre != null;
                var useNdviDims = (layer === ndviValueParcelWms) && parcelValueRasterWidth != null && parcelValueRasterHeight != null;
                if (useNdreDims) {
                    widthPx = parcelValueRasterWidthNdre;
                    heightPx = parcelValueRasterHeightNdre;
                } else if (useNdviDims) {
                    widthPx = parcelValueRasterWidth;
                    heightPx = parcelValueRasterHeight;
                } else if (parcelValueRasterWidth != null && parcelValueRasterHeight != null) {
                    widthPx = parcelValueRasterWidth;
                    heightPx = parcelValueRasterHeight;
                } else {
                    var centerLat = (minLat + maxLat) / 2;
                    var metersPerDegLon = 111320 * Math.max(0.1, Math.abs(Math.cos(centerLat * Math.PI / 180)));
                    var widthM = (maxLon - minLon) * metersPerDegLon;
                    var heightM = (maxLat - minLat) * 111320;
                    widthPx = Math.max(1, Math.min(PARCEL_RASTER_MAX_PIXELS, Math.round(widthM / PARCEL_RASTER_RESOLUTION_M)));
                    heightPx = Math.max(1, Math.min(PARCEL_RASTER_MAX_PIXELS, Math.round(heightM / PARCEL_RASTER_RESOLUTION_M)));
                }
                pixelX = Math.floor((latlng.lng - minLon) / (maxLon - minLon) * widthPx);
                pixelY = Math.floor((maxLat - latlng.lat) / (maxLat - minLat) * heightPx);
                pixelX = Math.max(0, Math.min(widthPx - 1, pixelX));
                pixelY = Math.max(0, Math.min(heightPx - 1, pixelY));
                if (typeof console !== "undefined" && console.log) {
                    console.log("[GetFeatureInfo] Parcel raster: " + widthPx + "x" + heightPx + ", piksel (" + pixelX + "," + pixelY + ")");
                }
            } else {
                var point = map.latLngToContainerPoint(latlng, map.getZoom());
                var size = map.getSize();
                var bounds = map.getBounds();
                var sw = map.options.crs.project(bounds.getSouthWest());
                var ne = map.options.crs.project(bounds.getNorthEast());
                bbox3857 = [sw.x, sw.y, ne.x, ne.y];
                widthPx = size.x;
                heightPx = size.y;
                pixelX = Math.floor(point.x);
                pixelY = Math.floor(point.y);
            }
            var params = {
                service: "WMS",
                request: "GetFeatureInfo",
                version: wmsVersion,
                layers: layer.wmsParams.layers,
                query_layers: layer.wmsParams.layers,
                styles: layer.wmsParams.styles,
                bbox: bbox3857.join(","),
                width: widthPx,
                height: heightPx,
                format: layer.wmsParams.format,
                transparent: layer.wmsParams.transparent,
                info_format: infoFormat || "application/json",
                srs: "EPSG:3857",
                x: pixelX,
                y: pixelY
            };
            if (wmsVersion === "1.3.0") {
                params.crs = "EPSG:3857";
                delete params.srs;
                params.i = pixelX;
                params.j = pixelY;
                delete params.x;
                delete params.y;
            }
            return layer._url + L.Util.getParamString(params, layer._url, true);
        }
        function fetchFeatureInfo(layer, latlng, infoFormat, useScreenCoords) {
            var url = buildFeatureInfoUrl(layer, latlng, infoFormat, undefined, useScreenCoords);
            return fetch(url)
                .then(function(response) {
                    if ((infoFormat || "").indexOf("application/json") !== -1) {
                        return response.json();
                    }
                    return response.text();
                });
        }
        function fetchFeatureInfo130(layer, latlng, infoFormat, useScreenCoords) {
            var url = buildFeatureInfoUrl(layer, latlng, infoFormat, "1.3.0", useScreenCoords);
            return fetch(url)
                .then(function(response) {
                    if ((infoFormat || "").indexOf("application/json") !== -1) {
                        return response.json();
                    }
                    return response.text();
                });
        }
        function normalizeIndexValue(value) {
            if (value === null || Number.isNaN(value) || value <= -100) {
                return null;
            }
            if (value >= 0 && value <= 1 && value !== Math.floor(value)) {
                return value;
            }
            if (value > 1 && value <= 255) {
                return value / 255;
            }
            if (value >= 100 && value <= 1000) {
                return value / 1000;
            }
            if (value > 1.5) {
                if (value <= 10000) {
                    return value / 10000;
                }
                return value / 65535;
            }
            return value;
        }
        function fetchFeatureValue(layer, latlng, useScreenCoords) {
            useScreenCoords = !!useScreenCoords;
            return fetchFeatureInfo(layer, latlng, "application/json", useScreenCoords)
                .then(function(payload) {
                    var value = normalizeIndexValue(extractFeatureValue(payload));
                    if (value === null || Number.isNaN(value)) {
                        return fetchFeatureInfo(layer, latlng, "text/plain", useScreenCoords)
                            .then(function(payloadPlain) {
                                return normalizeIndexValue(extractFeatureValue(payloadPlain));
                            });
                    }
                    return value;
                })
                .then(function(value) {
                    if (value !== null && !Number.isNaN(value)) {
                        return value;
                    }
                    return fetchFeatureInfo130(layer, latlng, "application/json", useScreenCoords)
                        .then(function(payload) {
                            var value130 = normalizeIndexValue(extractFeatureValue(payload));
                            if (value130 === null || Number.isNaN(value130)) {
                                return fetchFeatureInfo130(layer, latlng, "text/plain", useScreenCoords)
                                    .then(function(payloadPlain) {
                                        return normalizeIndexValue(extractFeatureValue(payloadPlain));
                                    });
                            }
                            return value130;
                        })
                        .then(function(value130) {
                            if (value130 !== null && !Number.isNaN(value130)) {
                                return value130;
                            }
                            return fetchFeatureInfo130(layer, latlng, "text/html", useScreenCoords)
                                .then(function(payloadHtml) {
                                    return normalizeIndexValue(extractFeatureValue(payloadHtml));
                                });
                        });
                });
        }
        function extractFeatureValue(payload) {
            if (!payload) {
                return null;
            }
            if (typeof payload === "object") {
                if (payload.features && payload.features.length) {
                    var props = payload.features[0].properties || {};
                    if (typeof props.GRAY_INDEX !== "undefined") {
                        return Number(props.GRAY_INDEX);
                    }
                    if (typeof props.value !== "undefined") {
                        return Number(props.value);
                    }
                    for (var key in props) {
                        if (props.hasOwnProperty(key)) {
                            var val = Number(props[key]);
                            if (Number.isFinite(val)) {
                                return val;
                            }
                        }
                    }
                }
                return null;
            }
            var text = String(payload);
            var match = text.match(/GRAY_INDEX\s*=\s*([-0-9.]+)/i) || text.match(/value\s*=\s*([-0-9.]+)/i);
            return match ? Number(match[1]) : null;
        }
        function interpretEvi(value) {
            if (value === null || Number.isNaN(value)) return t("interp_no_data");
            if (value < 0) return t("interp_water_cloud");
            if (value < 0.2) return t("interp_bare_soil");
            if (value < 0.4) return t("interp_sparse_stress");
            if (value < 0.6) return t("interp_good_veg");
            return t("interp_dense_healthy");
        }
        function interpretNdvi(value) {
            if (value === null || Number.isNaN(value)) return t("interp_no_data");
            if (value < 0) return t("interp_water_cloud");
            if (value < 0.2) return t("interp_bare_soil");
            if (value < 0.4) return t("interp_sparse_stress");
            if (value < 0.6) return t("interp_good_veg");
            return t("interp_dense_healthy");
        }
        function interpretNdmi(value) {
            if (value === null || Number.isNaN(value)) return t("interp_no_data");
            if (value < -0.2) return t("interp_very_dry");
            if (value < 0.0) return t("interp_dry");
            if (value < 0.2) return t("interp_moderate_moisture");
            if (value < 0.4) return t("interp_good_moisture");
            return t("interp_high_moisture");
        }
        function interpretNdre(value) {
            if (value === null || Number.isNaN(value)) return t("interp_no_data");
            if (value < 0.0) return t("interp_bare_soil");
            if (value < 0.1) return t("interp_weak_veg");
            if (value < 0.2) return t("interp_moderate_good_veg");
            if (value < 0.3) return t("interp_good_veg");
            return t("interp_very_good_veg");
        }
        map.on("click", function(e) {
            if (!indexInfo) {
                return;
            }
            var active = getActiveIndexLayer();
            if (!active) {
                showIndexInfo("<strong>" + t("index_label") + "</strong> " + t("enable_index_hint"));
                return;
            }
            function showValue(value) {
                var valueText = (value === null || Number.isNaN(value)) ? "n/a" : value.toFixed(3);
                var extra = "";
                if (active.label.indexOf("NDVI") !== -1) {
                    extra = "<div><strong>" + t("interpretation_label") + "</strong> " + interpretNdvi(value) + "</div>";
                    var ndviRows = allCsvData["NDVI"] || [];
                    if (ndviRows.length > 0) {
                        var latest = ndviRows.reduce(function(a, b) {
                            var da = a["C0/date"] ? new Date(a["C0/date"]).getTime() : 0;
                            var db = b["C0/date"] ? new Date(b["C0/date"]).getTime() : 0;
                            return db > da ? b : a;
                        });
                        var rowMin = latest["C0/min"] != null ? Number(latest["C0/min"]) : null;
                        var rowMax = latest["C0/max"] != null ? Number(latest["C0/max"]) : null;
                        if (rowMin !== null && rowMax !== null && Number.isFinite(rowMin) && Number.isFinite(rowMax)) {
                            extra = "<div><strong>" + t("range_parcel") + "</strong> " + t("min_label") + " " + rowMin.toFixed(3) + ", " + t("max_label") + " " + rowMax.toFixed(3) + "</div>" + extra;
                        }
                    }
                } else if (active.label.indexOf("NDRE") !== -1) {
                    var interpretation = interpretNdre(value);
                    var zone = getNdreZone(value);
                    extra = "<div><strong>Zona</strong> " + zone + "</div>";
                    extra += "<div><strong>" + t("interpretation_label") + "</strong> " + interpretation + "</div>";
                } else if (active.label.indexOf("NDMI") !== -1) {
                    extra = "<div><strong>" + t("interpretation_label") + "</strong> " + interpretNdmi(value) + "</div>";
                }
                if (value === null || Number.isNaN(value)) {
                    extra = "<div><strong>Napomena</strong> Van rastera ili NoData.</div>" + extra;
                }
                showIndexInfo("<strong>" + active.label + "</strong> Vrednost: " + valueText + extra);
            }
            var indexName = (active.label.indexOf("NDVI") !== -1) ? "NDVI" : (active.label.indexOf("NDRE") !== -1 ? "NDRE" : "NDMI");
            if (lastParcelSnapshotIsoDate && currentParcelId) {
                var valueAtPointUrl = parcelServerUrl + "/value_at_point?lat=" + encodeURIComponent(e.latlng.lat) + "&lon=" + encodeURIComponent(e.latlng.lng) + "&date=" + encodeURIComponent(lastParcelSnapshotIsoDate) + "&index=" + encodeURIComponent(indexName) + "&layer=" + encodeURIComponent(getSelectedOpstina()) + katOpstinaUrlParam();
                fetch(valueAtPointUrl)
                    .then(function(r) {
                        if (!r.ok) throw new Error("value_at_point " + r.status);
                        return r.json();
                    })
                    .then(function(data) {
                        var v = data && (data.value !== undefined && data.value !== null) ? Number(data.value) : null;
                        if (v !== null && !Number.isNaN(v)) {
                            showValue(v);
                            return;
                        }
                        return fetchFeatureValue(active.layer, e.latlng).then(function(v) {
                            if (v !== null && !Number.isNaN(v)) return showValue(v);
                            return fetchFeatureValue(active.layer, e.latlng, true).then(function(vScreen) {
                                if (vScreen !== null && !Number.isNaN(vScreen)) return showValue(vScreen);
                                if (indexName === "NDRE" && currentParcelId) {
                                    var ndreRows = allCsvData["NDRE"] || [];
                                    var latestNdre = ndreRows.filter(function(r) { return r.mean !== null; }).sort(function(a,b) { return new Date(b.date).getTime() - new Date(a.date).getTime(); })[0];
                                    if (latestNdre) {
                                        var csvMean = latestNdre.mean;
                                        var csvDate = latestNdre.date ? (String(latestNdre.date).split("T")[0]) : "";
                                        showIndexInfo("<strong>" + active.label + "</strong> Vrednost: n/a (taƒçka nema podataka)<br><div><strong>Srednja vrednost parcele (iz CSV " + csvDate + "):</strong> " + csvMean.toFixed(3) + "</div><div><strong>Zona</strong> " + getNdreZone(csvMean) + "</div><div><strong>" + t("interpretation_label") + "</strong> " + interpretNdre(csvMean) + "</div>");
                                        return;
                                    }
                                }
                                return showValue(null);
                            });
                        });
                    })
                    .catch(function() {
                        return fetchFeatureValue(active.layer, e.latlng).then(function(v) {
                            if (v !== null && !Number.isNaN(v)) return showValue(v);
                            return fetchFeatureValue(active.layer, e.latlng, true).then(function(vScreen) {
                                if (vScreen !== null && !Number.isNaN(vScreen)) return showValue(vScreen);
                                if (indexName === "NDRE" && currentParcelId) {
                                    var ndreRows = allCsvData["NDRE"] || [];
                                    var latestNdre = ndreRows.filter(function(r) { return r.mean !== null; }).sort(function(a,b) { return new Date(b.date).getTime() - new Date(a.date).getTime(); })[0];
                                    if (latestNdre) {
                                        var csvMean = latestNdre.mean;
                                        var csvDate = latestNdre.date ? (String(latestNdre.date).split("T")[0]) : "";
                                        showIndexInfo("<strong>" + active.label + "</strong> Vrednost: n/a (taƒçka nema podataka)<br><div><strong>Srednja vrednost parcele (iz CSV " + csvDate + "):</strong> " + csvMean.toFixed(3) + "</div><div><strong>Zona</strong> " + getNdreZone(csvMean) + "</div><div><strong>" + t("interpretation_label") + "</strong> " + interpretNdre(csvMean) + "</div>");
                                        return;
                                    }
                                }
                                return showValue(null);
                            });
                        });
                    })
                    .catch(function(err) {
                        console.error("GetFeatureInfo gre≈°ka:", err);
                        showIndexInfo("<strong>" + active.label + "</strong> Nije moguƒáe proƒçitati vrednost.");
                    });
            } else {
                fetchFeatureValue(active.layer, e.latlng)
                    .then(function(v) {
                        if (v !== null && !Number.isNaN(v)) return showValue(v);
                        return fetchFeatureValue(active.layer, e.latlng, true).then(function(vScreen) {
                            if (vScreen !== null && !Number.isNaN(vScreen)) return showValue(vScreen);
                            if (indexName === "NDRE" && currentParcelId) {
                                var ndreRows = allCsvData["NDRE"] || [];
                                var latestNdre = ndreRows.filter(function(r) { return r.mean !== null; }).sort(function(a,b) { return new Date(b.date).getTime() - new Date(a.date).getTime(); })[0];
                                if (latestNdre) {
                                    var csvMean = latestNdre.mean;
                                    var csvDate = latestNdre.date ? (String(latestNdre.date).split("T")[0]) : "";
                                    showIndexInfo("<strong>" + active.label + "</strong> Vrednost: n/a (taƒçka nema podataka)<br><div><strong>Srednja vrednost parcele (iz CSV " + csvDate + "):</strong> " + csvMean.toFixed(3) + "</div><div><strong>Zona</strong> " + getNdreZone(csvMean) + "</div><div><strong>" + t("interpretation_label") + "</strong> " + interpretNdre(csvMean) + "</div>");
                                    return;
                                }
                            }
                            return showValue(null);
                        });
                    })
                    .catch(function(err) {
                        console.error("GetFeatureInfo gre≈°ka:", err);
                        showIndexInfo("<strong>" + active.label + "</strong> Nije moguƒáe proƒçitati vrednost.");
                    });
            }
        });

        document.getElementById("parcelBtn").addEventListener("click", function() {
            var val = document.getElementById("parcelInput").value.trim();
            zoomToParcel(val);
        });
        document.getElementById("parcelInput").addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                zoomToParcel(this.value.trim());
            }
        });
        document.getElementById("parcelInput").addEventListener("input", function() {
            var val = this.value.trim();
            clearTimeout(parcelSuggestTimer);
            if (val.length < 2) {
                updateParcelOptions([]);
                return;
            }
            parcelSuggestTimer = setTimeout(function() {
                suggestParcels(val);
            }, 250);
        });
        document.getElementById("parcelInput").addEventListener("blur", function() {
            setTimeout(function() {
                var dd = document.getElementById("parcelDropdown");
                if (dd) dd.style.display = "none";
            }, 200);
        });
        document.getElementById("parcelInput").addEventListener("change", function() {
            var val = this.value.trim();
            if (val) {
                var inputEl = this;
                setTimeout(function() {
                    inputEl.blur();
                }, 500);
            }
        });
        
        // Resetuj sugestije i uƒçitaj kat. op≈°tine kada se promeni op≈°tina
        document.getElementById("opstinaSelect").addEventListener("change", function() {
            document.getElementById("parcelInput").value = "";
            updateParcelOptions([]);
            var statusEl = document.getElementById("parcelStatus");
            if (statusEl) {
                statusEl.textContent = t("select_opstina_parcel");
            }
            loadKatOpstineForOpstina();
        });
        // Resetuj sugestije kada se promeni katastarska op≈°tina
        document.getElementById("katOpstinaSelect").addEventListener("change", function() {
            document.getElementById("parcelInput").value = "";
            updateParcelOptions([]);
            var statusEl = document.getElementById("parcelStatus");
            if (statusEl) {
                statusEl.textContent = t("parcel_status_enter");
            }
            document.getElementById("parcelInput").focus();
        });
        loadKatOpstineForOpstina();
        function injectDroughtSlider() {
            var container = layerControl && layerControl._container;
            if (!container) {
                return;
            }
            if (container.querySelector("#droughtOpacity")) {
                return;
            }
            var labels = container.querySelectorAll(".leaflet-control-layers-overlays label");
            var targetLabel = null;
            labels.forEach(function(label) {
                if (label.textContent && label.textContent.indexOf(t("stress_drought")) !== -1) {
                    targetLabel = label;
                }
            });
            if (!targetLabel) {
                return;
            }
            var wrapper = document.createElement("div");
            wrapper.className = "opacity-control";
            wrapper.innerHTML = "<div>" + t("stress_drought") + " ‚Äî " + t("transparency") + "</div>" +
                "<input id=\"droughtOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"100\" />";
            _stopSliderPropagation(wrapper);
            targetLabel.parentNode.insertBefore(wrapper, targetLabel.nextSibling);
            document.getElementById("droughtOpacity").addEventListener("input", function() {
                var val = parseInt(this.value, 10);
                droughtWms.setOpacity(val / 100);
            });
        }

        function injectEviSlider() {
            var container = layerControl && layerControl._container;
            if (!container) {
                return;
            }
            if (container.querySelector("#eviOpacity")) {
                return;
            }
            var labels = container.querySelectorAll(".leaflet-control-layers-overlays label");
            var targetLabel = null;
            labels.forEach(function(label) {
                if (label.textContent && label.textContent.indexOf("EVI") !== -1) {
                    targetLabel = label;
                }
            });
            if (!targetLabel) {
                return;
            }
            var wrapper = document.createElement("div");
            wrapper.className = "opacity-control";
            wrapper.innerHTML = "<div>" + t("evi") + " ‚Äî " + t("transparency") + "</div>" +
                "<input id=\"eviOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"100\" />";
            _stopSliderPropagation(wrapper);
            targetLabel.parentNode.insertBefore(wrapper, targetLabel.nextSibling);
            document.getElementById("eviOpacity").addEventListener("input", function() {
                var val = parseInt(this.value, 10);
                eviWms.setOpacity(val / 100);
            });
        }

        function injectNdreSlider() {
            var container = layerControl && layerControl._container;
            if (!container) {
                return;
            }
            if (container.querySelector("#ndreOpacity")) {
                return;
            }
            var labels = container.querySelectorAll(".leaflet-control-layers-overlays label");
            var targetLabel = null;
            labels.forEach(function(label) {
                // Tra≈æi samo "NDRE" bez "(parcela)" - to je glavni NDRE sloj za celu Srbiju
                if (label.textContent && label.textContent.indexOf("NDRE") !== -1 && label.textContent.indexOf("(parcela)") === -1) {
                    targetLabel = label;
                }
            });
            if (!targetLabel) {
                return;
            }
            var wrapper = document.createElement("div");
            wrapper.className = "opacity-control";
            wrapper.innerHTML = "<div>" + t("ndre") + " ‚Äî " + t("transparency") + "</div>" +
                "<input id=\"ndreOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"100\" />";
            _stopSliderPropagation(wrapper);
            targetLabel.parentNode.insertBefore(wrapper, targetLabel.nextSibling);
            document.getElementById("ndreOpacity").addEventListener("input", function() {
                var val = parseInt(this.value, 10);
                ndreWms.setOpacity(val / 100);
            });
        }

        function injectNdmiSlider() {
            var container = layerControl && layerControl._container;
            if (!container) {
                return;
            }
            if (container.querySelector("#ndmiOpacity")) {
                return;
            }
            var labels = container.querySelectorAll(".leaflet-control-layers-overlays label");
            var targetLabel = null;
            labels.forEach(function(label) {
                if (label.textContent && label.textContent.indexOf(t("moisture_index")) !== -1) {
                    targetLabel = label;
                }
            });
            if (!targetLabel) {
                return;
            }
            var wrapper = document.createElement("div");
            wrapper.className = "opacity-control";
            wrapper.innerHTML = "<div>" + t("moisture_index") + " ‚Äî " + t("transparency") + "</div>" +
                "<input id=\"ndmiOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"100\" />";
            _stopSliderPropagation(wrapper);
            targetLabel.parentNode.insertBefore(wrapper, targetLabel.nextSibling);
            document.getElementById("ndmiOpacity").addEventListener("input", function() {
                var val = parseInt(this.value, 10);
                ndmiWms.setOpacity(val / 100);
            });
        }

        setTimeout(injectParcelSliders, 500);
        setTimeout(normalizeOverlayOrder, 0);
        
        function _stopSliderPropagation(wrapper) {
            ["click", "mousedown", "mouseup", "touchstart", "pointerdown", "change", "input", "dblclick"].forEach(function(evt) {
                wrapper.addEventListener(evt, function(e) { e.stopPropagation(); });
            });
            L.DomEvent.disableClickPropagation(wrapper);
        }

        function injectParcelSliders() {
            var container = layerControl && layerControl._container;
            if (!container) {
                return;
            }
            var labels = container.querySelectorAll(".leaflet-control-layers-overlays label");
            
            // NDVI (parcela) slider
            var ndviLabel = null;
            labels.forEach(function(label) {
                if (label.textContent && label.textContent.indexOf(t("ndvi_parcela")) !== -1) {
                    ndviLabel = label;
                }
            });
            if (ndviLabel) {
                var existing = container.querySelector("#ndviParcelOpacity");
                if (existing && existing.parentNode) {
                    existing.parentNode.remove();
                }
                var wrapper = document.createElement("div");
                wrapper.className = "opacity-control";
                wrapper.innerHTML = "<div>" + t("ndvi_parcela") + " ‚Äî " + t("transparency") + "</div>" +
                    "<input id=\"ndviParcelOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"0\" />";
                _stopSliderPropagation(wrapper);
                ndviLabel.parentNode.insertBefore(wrapper, ndviLabel.nextSibling);
                document.getElementById("ndviParcelOpacity").addEventListener("input", function() {
                    var val = parseInt(this.value, 10);
                    ndviWms.setOpacity(val / 100);
                });
            }
            
            // NDMI (parcela) slider
            var ndmiParcelLabel = null;
            labels.forEach(function(label) {
                if (label.textContent && label.textContent.indexOf(t("ndmi_parcela")) !== -1) {
                    ndmiParcelLabel = label;
                }
            });
            if (ndmiParcelLabel) {
                var existing = container.querySelector("#ndmiParcelOpacity");
                if (existing && existing.parentNode) {
                    existing.parentNode.remove();
                }
                var wrapper = document.createElement("div");
                wrapper.className = "opacity-control";
                wrapper.innerHTML = "<div>" + t("ndmi_parcela") + " ‚Äî " + t("transparency") + "</div>" +
                    "<input id=\"ndmiParcelOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"0\" />";
                _stopSliderPropagation(wrapper);
                ndmiParcelLabel.parentNode.insertBefore(wrapper, ndmiParcelLabel.nextSibling);
                document.getElementById("ndmiParcelOpacity").addEventListener("input", function() {
                    var val = parseInt(this.value, 10);
                    ndmiParcelWms.setOpacity(val / 100);
                });
            }
            
            // NDRE (parcela) slider
            var ndreParcelLabel = null;
            labels.forEach(function(label) {
                if (label.textContent && label.textContent.indexOf(t("ndre_parcela")) !== -1) {
                    ndreParcelLabel = label;
                }
            });
            if (ndreParcelLabel) {
                var existing = container.querySelector("#ndreParcelOpacity");
                if (existing && existing.parentNode) {
                    existing.parentNode.remove();
                }
                var wrapper = document.createElement("div");
                wrapper.className = "opacity-control";
                wrapper.innerHTML = "<div>" + t("ndre_parcela") + " ‚Äî " + t("transparency") + "</div>" +
                    "<input id=\"ndreParcelOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"0\" />";
                _stopSliderPropagation(wrapper);
                ndreParcelLabel.parentNode.insertBefore(wrapper, ndreParcelLabel.nextSibling);
                document.getElementById("ndreParcelOpacity").addEventListener("input", function() {
                    var val = parseInt(this.value, 10);
                    ndreParcelWms.setOpacity(val / 100);
                });
            }
            
            // NDRE Zones (parcela) slider
            var ndreZonesParcelLabel = null;
            labels.forEach(function(label) {
                if (label.textContent && label.textContent.indexOf(t("ndre_zone_parcela")) !== -1) {
                    ndreZonesParcelLabel = label;
                }
            });
            if (ndreZonesParcelLabel) {
                var existing = container.querySelector("#ndreZonesParcelOpacity");
                if (existing && existing.parentNode) {
                    existing.parentNode.remove();
                }
                var wrapper = document.createElement("div");
                wrapper.className = "opacity-control";
                wrapper.innerHTML = "<div>" + t("ndre_zone_parcela") + " ‚Äî " + t("transparency") + "</div>" +
                    "<input id=\"ndreZonesParcelOpacity\" type=\"range\" min=\"0\" max=\"100\" value=\"70\" />";
                _stopSliderPropagation(wrapper);
                ndreZonesParcelLabel.parentNode.insertBefore(wrapper, ndreZonesParcelLabel.nextSibling);
                document.getElementById("ndreZonesParcelOpacity").addEventListener("input", function() {
                    var val = parseInt(this.value, 10);
                    ndreZonesParcelWms.setOpacity(val / 100);
                });
            }
        }

        function setNdviLayerForParcel(parcelId) {
            var safeId = getParcelLayerSuffix(parcelId);
            var layerName = "moj_projekat:ndvi_parcela_" + safeId;
            var valueLayerName = "moj_projekat:ndvi_value_parcela_" + safeId;
            ndviWms.setParams(isServer ? { layers: layerName, styles: '' } : { layers: layerName, styles: '', cacheBust: Date.now() });
            ndviValueParcelWms.setParams(isServer ? { layers: valueLayerName, styles: 'raster' } : { layers: valueLayerName, styles: 'raster', cacheBust: Date.now() });
            if (!map.hasLayer(ndviWms)) {
                ndviWms.addTo(map);
            }
            ndviWms.setOpacity(0.3);
            setTimeout(injectParcelSliders, 100);
        }
        function setNdmiLayerForParcel(parcelId) {
            var safeId = getParcelLayerSuffix(parcelId);
            var layerName = "moj_projekat:ndmi_parcela_" + safeId;
            ndmiParcelWms.setParams(isServer ? { layers: layerName, styles: '' } : { layers: layerName, styles: '', cacheBust: Date.now() });
            if (!map.hasLayer(ndmiParcelWms)) {
                ndmiParcelWms.addTo(map);
            }
            // Ponovo dodaj slider-e nakon ≈°to se sloj doda
            setTimeout(injectParcelSliders, 100);
        }
        function setNdreLayerForParcel(parcelId) {
            var safeId = getParcelLayerSuffix(parcelId);
            var layerName = "moj_projekat:ndre_parcela_" + safeId;
            ndreParcelWms.setParams(isServer ? { layers: layerName, styles: '' } : { layers: layerName, styles: '', cacheBust: Date.now() });
            if (!map.hasLayer(ndreParcelWms)) {
                ndreParcelWms.addTo(map);
            }
            // ndreValueParcelWms se postavlja SAMO u setNdreZonesLayerForParcel, nakon uspe≈°nog ndre_value
            // (da ne bi pokazivali na ndre_value_parcela_X ako script nije uspeo za tu parcelu)
            setTimeout(injectParcelSliders, 100);
        }
        function setNdreZonesLayerForParcel(parcelId) {
            if (!parcelId) {
                console.warn("setNdreZonesLayerForParcel: nema parcelId");
                return;
            }
            var safeId = getParcelLayerSuffix(parcelId);
            // Koristimo ndre_value raster + ColorMap stil (crvena/zuta/zelena) ‚Äì isti podaci kao GetFeatureInfo
            var layerName = "moj_projekat:ndre_value_parcela_" + safeId;
            var zoneStyle = "ndre_zones_percentile_style";
            console.log("Postavljam NDRE zones (value + ColorMap):", layerName, zoneStyle);
            ndreZonesParcelWms.setParams(isServer ? { layers: layerName, styles: zoneStyle } : { layers: layerName, styles: zoneStyle, cacheBust: Date.now() });
            if (!map.hasLayer(ndreZonesParcelWms)) {
                ndreZonesParcelWms.addTo(map);
            }
            ndreZonesParcelWms.bringToFront();
            ndreZonesParcelWms.setOpacity(1.0);
            // Value layer za GetFeatureInfo (isti podaci)
            ndreValueParcelWms.setParams(isServer ? { layers: layerName, styles: 'raster' } : { layers: layerName, styles: 'raster', cacheBust: Date.now() });
            // Prika≈æi panel o snimku samo kad je parcela izabrana i NDRE sloj dodat
            updateNdreSnapshotPanelVisibility();
            // Ponovo dodaj slider-e nakon ≈°to se sloj doda
            setTimeout(injectParcelSliders, 100);
        }

        var lastParcelSnapshotDate = "";
        var lastParcelSnapshotIsoDate = "";  // ISO YYYY-MM-DD za value_at_point
        var lastParcelSnapshotCriterion = "";
        var lastParcelSnapshotValidPixels = null;
        var lastParcelSnapshotTotalPixels = null;
        var lastParcelSnapshotValidPct = null;
        var lastParcelSnapshotCloudPct = null;

        function setParcelImageDate(isoDate, criterionText, loadingLayer) {
            var el = document.getElementById("parcelImageDate");
            if (!el) return;
            if (!isoDate) {
                el.style.display = "none";
                el.innerHTML = "";
                lastParcelSnapshotDate = "";
                lastParcelSnapshotIsoDate = "";
                lastParcelSnapshotCriterion = "";
                lastParcelSnapshotValidPixels = lastParcelSnapshotTotalPixels = lastParcelSnapshotValidPct = lastParcelSnapshotCloudPct = null;
                return;
            }
            lastParcelSnapshotIsoDate = (isoDate.indexOf("T") >= 0 ? isoDate.split("T")[0] : isoDate).substring(0, 10);
            var d = new Date(isoDate + "T12:00:00Z");
            var formatted = d.toLocaleDateString("sr-RS", { day: "numeric", month: "numeric", year: "numeric" });
            var html = t("snapshot_from") + " <strong>" + formatted + "</strong>";
            if (loadingLayer) {
                html += " ‚Äî " + t("loading_layer") + " <strong>" + loadingLayer + "</strong>";
            } else {
                html += " (NDVI / NDMI / NDRE)";
                lastParcelSnapshotDate = formatted;
                if (criterionText !== undefined) lastParcelSnapshotCriterion = criterionText || "";
                refreshNdreSnapshotPanelContent();
            }
            el.innerHTML = html;
        }
        function setParcelSnapshotMetadata(validPixels, totalPixels, validPct, cloudPct) {
            lastParcelSnapshotValidPixels = validPixels;
            lastParcelSnapshotTotalPixels = totalPixels;
            lastParcelSnapshotValidPct = validPct;
            lastParcelSnapshotCloudPct = cloudPct;
            if (typeof refreshNdreSnapshotPanelContent === "function") refreshNdreSnapshotPanelContent();
        }

        function refreshNdreSnapshotPanelContent() {
            var ndreCriterionEl = document.getElementById("ndreSnapshotCriterion");
            var ndreDateEl = document.getElementById("ndreSnapshotDate");
            if (ndreCriterionEl) {
                var line = "";
                if (lastParcelSnapshotValidPixels != null && lastParcelSnapshotTotalPixels != null) {
                    line = t("valid_pixels_label") + " " + lastParcelSnapshotValidPixels + " (" + (lastParcelSnapshotValidPct != null ? lastParcelSnapshotValidPct + "%" : "‚Äî") + ")";
                    if (lastParcelSnapshotCloudPct != null) {
                        line += ". " + t("cloud_cover_label") + " " + lastParcelSnapshotCloudPct + "%";
                    }
                } else if (lastParcelSnapshotCriterion) {
                    line = t("criterion_label") + " " + lastParcelSnapshotCriterion;
                }
                ndreCriterionEl.textContent = line;
                ndreCriterionEl.style.display = line ? "block" : "none";
                ndreCriterionEl.style.visibility = "visible";
            }
            if (ndreDateEl) {
                ndreDateEl.textContent = lastParcelSnapshotDate ? (t("date_label") + " " + lastParcelSnapshotDate) : "";
                ndreDateEl.style.display = "block";
                ndreDateEl.style.visibility = "visible";
            }
        }

        function updateNdreSnapshotPanelVisibility() {
            var legendEl = document.getElementById("ndreZonesLegend");
            if (!legendEl) return;
            var show = currentParcelId && map.hasLayer(ndreZonesParcelWms);
            legendEl.style.display = show ? "block" : "none";
            if (show) {
                refreshNdreSnapshotPanelContent();
                var controlsEl = document.querySelector(".controls");
                if (controlsEl) {
                    var rect = controlsEl.getBoundingClientRect();
                    var offsetDown = window.innerHeight * 0.05;
                    legendEl.style.top = (rect.bottom + 8 + offsetDown) + "px";
                    legendEl.style.bottom = "auto";
                    legendEl.style.right = "12px";
                }
            }
        }

        function setParcelStatusWithLoading(parcelId, loadingMsg) {
            var statusEl = document.getElementById("parcelStatus");
            if (!statusEl) return;
            var base = t("parcel_label") + " " + parcelId + " " + t("parcel_found");
            if (loadingMsg) {
                statusEl.innerHTML = base + "<br>" + loadingMsg;
            } else {
                statusEl.textContent = base;
            }
        }
        function requestParcelRastersWithCommonDate(parcelId) {
            var layerName = getSelectedOpstina();
            var base = parcelServerUrl + "?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName);
            fetch(parcelServerUrl + "/ndre_csv?parcel=" + encodeURIComponent(parcelId) + "&days=1825&cloud=100&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                .then(function(r) { return r.ok ? r.json() : r.json().then(function() { throw new Error("NDRE CSV error"); }); })
                .then(function(csvData) {
                    var latestDate = null;
                    var latestCriterion = null;
                    var validPixels = null, totalPixels = null, validPct = null, cloudPct = null;
                    if (csvData && csvData.stdout) {
                        var m = csvData.stdout.match(/LATEST_DATE=(\d{4}-\d{2}-\d{2})/);
                        if (m) latestDate = m[1];
                        var mc = csvData.stdout.match(/LATEST_CRITERION=([^\n]+)/);
                        if (mc) latestCriterion = mc[1].trim();
                        var mv = csvData.stdout.match(/LATEST_VALID_PIXELS=(\d+)/);
                        var mt = csvData.stdout.match(/LATEST_TOTAL_PIXELS=(\d+)/);
                        var mp = csvData.stdout.match(/LATEST_VALID_PCT=([\d.]+)/);
                        var mcl = csvData.stdout.match(/LATEST_CLOUD_PCT=([\d.]+)/);
                        if (mv) validPixels = parseInt(mv[1], 10);
                        if (mt) totalPixels = parseInt(mt[1], 10);
                        if (mp) validPct = parseFloat(mp[1]);
                        if (mcl) cloudPct = parseFloat(mcl[1]);
                    }
                    if (validPixels != null && totalPixels != null && window.setParcelSnapshotMetadata) {
                        window.setParcelSnapshotMetadata(validPixels, totalPixels, validPct, cloudPct);
                    }
                    if (latestDate && window.setParcelImageDate) window.setParcelImageDate(latestDate, latestCriterion, "NDVI");
                    if (csvData && csvData.csv && parcelId) {
                        var rows = parseCsv(csvData.csv);
                        if (rows.length > 0) {
                            parcelCsvRows["NDRE"] = rows;
                            allCsvData["NDRE"] = rows.map(function(row) {
                                return { date: row["C0/date"], mean: toNumber(row["C0/mean"]), min: toNumber(row["C0/min"]), max: toNumber(row["C0/max"]), median: toNumber(row["C0/median"]), cloud: toNumber(row["C0/cloudCoveragePercent"]) };
                            }).filter(function(row) { return row.date && row.mean !== null; });
                        }
                    }
                    parcelValueRasterWidth = null;
                    parcelValueRasterHeight = null;
                    parcelValueRasterWidthNdre = null;
                    parcelValueRasterHeightNdre = null;
                    var runUrl = parcelServerUrl + "/run?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam();
                    var ndviValueUrl = parcelServerUrl + "/ndvi_value?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam();
                    var ndmiUrl = parcelServerUrl + "/ndmi?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam();
                    var ndreUrl = parcelServerUrl + "/ndre?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam();
                    var ndreValueUrl = parcelServerUrl + "/ndre_value?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam();
                    if (latestDate) {
                        runUrl += "&date=" + encodeURIComponent(latestDate);
                        ndviValueUrl += "&date=" + encodeURIComponent(latestDate);
                        ndmiUrl += "&date=" + encodeURIComponent(latestDate);
                        ndreUrl += "&date=" + encodeURIComponent(latestDate);
                        ndreValueUrl += "&date=" + encodeURIComponent(latestDate);
                    }
                    if (latestCriterion) {
                        runUrl += "&criterion=" + encodeURIComponent(latestCriterion);
                        ndviValueUrl += "&criterion=" + encodeURIComponent(latestCriterion);
                        ndmiUrl += "&criterion=" + encodeURIComponent(latestCriterion);
                        ndreUrl += "&criterion=" + encodeURIComponent(latestCriterion);
                        ndreValueUrl += "&criterion=" + encodeURIComponent(latestCriterion);
                    }
                    setParcelStatusWithLoading(parcelId, t("loading_ndvi"));
                    return fetch(runUrl).then(function(r) { return r.json().catch(function() { return {}; }); })
                        .then(function() {
                            return fetch(ndviValueUrl).then(function(r) { return r.json().catch(function() { return {}; }); });
                        })
                        .then(function(ndviValueResult) {
                            if (ndviValueResult && ndviValueResult.stdout) {
                                var mw = ndviValueResult.stdout.match(/VALUE_RASTER_WIDTH=(\d+)/);
                                var mh = ndviValueResult.stdout.match(/VALUE_RASTER_HEIGHT=(\d+)/);
                                if (mw) parcelValueRasterWidth = parseInt(mw[1], 10);
                                if (mh) parcelValueRasterHeight = parseInt(mh[1], 10);
                            }
                            setNdviLayerForParcel(parcelId);
                            setParcelStatusWithLoading(parcelId, t("loading_ndmi"));
                            if (latestDate && window.setParcelImageDate) window.setParcelImageDate(latestDate, latestCriterion, "NDMI");
                            return fetch(ndmiUrl);
                        })
                        .then(function(r) { return r.json().catch(function() { return {}; }); })
                        .then(function() {
                            setNdmiLayerForParcel(parcelId);
                            setParcelStatusWithLoading(parcelId, t("loading_ndre"));
                            if (latestDate && window.setParcelImageDate) window.setParcelImageDate(latestDate, latestCriterion, "NDRE");
                            return fetch(ndreUrl);
                        })
                        .then(function(r) { return r.json().catch(function() { return {}; }); })
                        .then(function() {
                            setNdreLayerForParcel(parcelId);
                            return fetch(ndreValueUrl);
                        })
                        .then(function(r) { return r.json().catch(function() { return {}; }); })
                        .then(function(ndreValueResult) {
                            var ndreValueOk = ndreValueResult && !ndreValueResult.error;
                            if (ndreValueOk && ndreValueResult.stdout) {
                                var mw = ndreValueResult.stdout.match(/VALUE_RASTER_WIDTH=(\d+)/);
                                var mh = ndreValueResult.stdout.match(/VALUE_RASTER_HEIGHT=(\d+)/);
                                if (mw) parcelValueRasterWidthNdre = parseInt(mw[1], 10);
                                if (mh) parcelValueRasterHeightNdre = parseInt(mh[1], 10);
                            }
                            if (ndreValueOk) {
                                setNdreZonesLayerForParcel(parcelId);
                            } else if (ndreValueResult && ndreValueResult.error) {
                                console.warn("NDRE value raster nije uspeo za parcelu", parcelId, "-", ndreValueResult.stderr || ndreValueResult.error);
                            }
                            setParcelStatusWithLoading(parcelId, null);
                            if (latestDate && window.setParcelImageDate) window.setParcelImageDate(latestDate, latestCriterion, null);
                            if (allCsvData["NDRE"] && allCsvData["NDRE"].length > 0) {
                                buildAutoReport();
                            } else {
                                setTimeout(function() { waitForParcelCsv(parcelId, 8, "NDRE"); }, 1500);
                            }
                        });
                })
                .catch(function(err) {
                    console.error("Parcel rasters nisu dostupni:", err);
                    setParcelStatusWithLoading(parcelId, null);
                });
        }

        // Parcel server URL ‚Äì na serveru kroz nginx proxy (/parcel) sa rate limiting
        var parcelServerUrl = (function() {
            if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
                return "http://localhost:5010";
            }
            return window.location.origin + "/parcel";
        })();

        function requestParcelNdvi(parcelId) {
            var layerName = getSelectedOpstina();
            fetch(parcelServerUrl + "/run?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error("NDVI server error");
                    }
                    return response.json();
                })
                .then(function() {
                    setNdviLayerForParcel(parcelId);
                    setNdmiLayerForParcel(parcelId);
                    setNdreLayerForParcel(parcelId);
                })
                .catch(function(err) {
                    console.error("NDVI auto nije dostupan:", err);
                });
        }
        function requestParcelNdmi(parcelId) {
            var layerName = getSelectedOpstina();
            fetch(parcelServerUrl + "/ndmi?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error("NDMI server error");
                    }
                    return response.json();
                })
                .then(function() {
                    setNdmiLayerForParcel(parcelId);
                })
                .catch(function(err) {
                    console.error("NDMI auto nije dostupan:", err);
                });
        }
        function requestParcelNdre(parcelId) {
            var layerName = getSelectedOpstina();
            fetch(parcelServerUrl + "/ndre_csv?parcel=" + encodeURIComponent(parcelId) + "&days=1825&cloud=100&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                .then(function(r) { return r.ok ? r.json() : r.json().then(function() { throw new Error("NDRE CSV error"); }); })
                .then(function(csvData) {
                    var latestDate = null;
                    var latestCriterion = null;
                    if (csvData && csvData.stdout) {
                        var m = csvData.stdout.match(/LATEST_DATE=(\d{4}-\d{2}-\d{2})/);
                        if (m) latestDate = m[1];
                        var mc = csvData.stdout.match(/LATEST_CRITERION=([^\n]+)/);
                        if (mc) latestCriterion = mc[1].trim();
                    }
                    return fetch(parcelServerUrl + "/ndre?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                        .then(function(response) {
                            if (!response.ok) throw new Error("NDRE server error");
                            return response.json();
                        })
                        .then(function() {
                            var url = parcelServerUrl + "/ndre_value?parcel=" + encodeURIComponent(parcelId) + "&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam();
                            if (latestDate) url += "&date=" + encodeURIComponent(latestDate);
                            if (latestCriterion) url += "&criterion=" + encodeURIComponent(latestCriterion);
                            return fetch(url);
                        })
                        .then(function(resp) {
                            if (!resp.ok) return resp.json().then(function(errData) { return { failed: true, error: errData }; });
                            return resp.json();
                        })
                        .then(function(data) {
                            setNdreLayerForParcel(parcelId);
                            if (data && !data.failed) {
                                setNdreZonesLayerForParcel(parcelId);
                                var mw = (data.stdout || "").match(/VALUE_RASTER_WIDTH=(\d+)/);
                                var mh = (data.stdout || "").match(/VALUE_RASTER_HEIGHT=(\d+)/);
                                if (mw) parcelValueRasterWidthNdre = parseInt(mw[1], 10);
                                if (mh) parcelValueRasterHeightNdre = parseInt(mh[1], 10);
                            } else if (data && data.error) {
                                console.warn("NDRE value nije uspeo za parcelu", parcelId, "-", data.error.stderr || data.error.error);
                            }
                            var imgDate = null;
                            var imgCriterion = null;
                            if (data && !data.failed && data.stdout) {
                                var m = data.stdout.match(/IMAGE_DATE=(\d{4}-\d{2}-\d{2})/);
                                if (m) imgDate = m[1];
                                var mc = data.stdout.match(/IMAGE_CRITERION=([^\n]+)/);
                                if (mc) imgCriterion = mc[1].trim();
                            }
                            if (window.setParcelImageDate) window.setParcelImageDate(imgDate || null, imgCriterion || null);
                        });
                })
                .catch(function(err) {
                    console.error("NDRE auto nije dostupan:", err);
                });
        }
        function requestParcelNdreZones(parcelId) {
            if (!parcelId) return;
            setNdreZonesLayerForParcel(parcelId);
        }
        function requestParcelNdviCsv(parcelId) {
            if (!parcelId) {
                return;
            }
            var layerName = getSelectedOpstina();
            fetch(parcelServerUrl + "/csv?parcel=" + encodeURIComponent(parcelId) + "&days=1825&cloud=100&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                .then(function(response) {
                    return response.text().then(function(text) {
                        if (!text || text.trim().length === 0) {
                            throw new Error("Prazan odgovor od servera. Proverite da li je parcel server pokrenut.");
                        }
                        var payload = null;
                        try {
                            payload = JSON.parse(text);
                        } catch (parseErr) {
                            console.error("JSON parse gre≈°ka:", parseErr, "Text:", text);
                            throw new Error("Neispravan JSON odgovor: " + (text.substring(0, 100) || "prazan odgovor"));
                        }
                        if (!response.ok) {
                            var detail = "";
                            if (payload) {
                                detail = payload.stderr || payload.stdout || payload.error || "";
                            }
                            var msg = detail || text || "NDVI CSV server error";
                            throw new Error(msg);
                        }
                        return payload || {};
                    });
                })
                .then(function(payload) {
                    lastCsvError = null;
                    if (payload && payload.csv) {
                        var rows = parseCsv(payload.csv);
                        if (parcelId && rows.length > 0) {
                            parcelCsvRows["NDVI"] = rows;
                            allCsvData["NDVI"] = rows.map(function(row) {
                                return { date: row["C0/date"], mean: toNumber(row["C0/mean"]), min: toNumber(row["C0/min"]), max: toNumber(row["C0/max"]), median: toNumber(row["C0/median"]), cloud: toNumber(row["C0/cloudCoveragePercent"]) };
                            }).filter(function(row) { return row.date && row.mean !== null; });
                        }
                        buildAutoReport();
                    } else {
                        setTimeout(function() { waitForParcelCsv(parcelId, 8); }, 2000);
                    }
                })
                .catch(function(err) {
                    console.error("NDVI CSV nije dostupan:", err);
                    lastCsvError = err.message;
                    var statusEl = document.getElementById("parcelStatus");
                    if (statusEl) {
                        statusEl.textContent = t("csv_error_parcel") + " " + parcelId + ": " + err.message;
                    }
                });
        }
        function requestParcelNdmiCsv(parcelId) {
            if (!parcelId) {
                return;
            }
            var layerName = getSelectedOpstina();
            fetch(parcelServerUrl + "/ndmi_csv?parcel=" + encodeURIComponent(parcelId) + "&days=1825&cloud=100&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                .then(function(response) {
                    return response.text().then(function(text) {
                        if (!text || text.trim().length === 0) {
                            throw new Error("Prazan odgovor od servera. Proverite da li je parcel server pokrenut.");
                        }
                        var payload = null;
                        try {
                            payload = JSON.parse(text);
                        } catch (parseErr) {
                            console.error("JSON parse gre≈°ka:", parseErr, "Text:", text);
                            throw new Error("Neispravan JSON odgovor: " + (text.substring(0, 100) || "prazan odgovor"));
                        }
                        if (!response.ok) {
                            var msg = (payload && payload.error) ? payload.error : (text || "NDMI CSV server error");
                            throw new Error(msg);
                        }
                        return payload || {};
                    });
                })
                .then(function(payload) {
                    if (payload && payload.csv) {
                        var rows = parseCsv(payload.csv);
                        if (parcelId && rows.length > 0) {
                            parcelCsvRows["NDMI"] = rows;
                            allCsvData["NDMI"] = rows.map(function(row) {
                                return { date: row["C0/date"], mean: toNumber(row["C0/mean"]), min: toNumber(row["C0/min"]), max: toNumber(row["C0/max"]), median: toNumber(row["C0/median"]), cloud: toNumber(row["C0/cloudCoveragePercent"]) };
                            }).filter(function(row) { return row.date && row.mean !== null; });
                        }
                        buildAutoReport();
                    } else {
                        setTimeout(function() { waitForParcelCsv(parcelId, 8, "NDMI"); }, 2000);
                    }
                })
                .catch(function(err) {
                    console.error("NDMI CSV nije dostupan:", err);
                });
        }
        function requestParcelNdreCsv(parcelId) {
            if (!parcelId) {
                return;
            }
            var layerName = getSelectedOpstina();
            fetch(parcelServerUrl + "/ndre_csv?parcel=" + encodeURIComponent(parcelId) + "&days=1825&cloud=100&layer=" + encodeURIComponent(layerName) + katOpstinaUrlParam())
                .then(function(response) {
                    return response.text().then(function(text) {
                        if (!text || text.trim().length === 0) {
                            throw new Error("Prazan odgovor od servera. Proverite da li je parcel server pokrenut.");
                        }
                        var payload = null;
                        try {
                            payload = JSON.parse(text);
                        } catch (parseErr) {
                            console.error("JSON parse gre≈°ka:", parseErr, "Text:", text);
                            throw new Error("Neispravan JSON odgovor: " + (text.substring(0, 100) || "prazan odgovor"));
                        }
                        if (!response.ok) {
                            var msg = (payload && payload.error) ? payload.error : (text || "NDRE CSV server error");
                            throw new Error(msg);
                        }
                        return payload || {};
                    });
                })
                .then(function(payload) {
                    if (payload && payload.csv) {
                        var rows = parseCsv(payload.csv);
                        if (parcelId && rows.length > 0) {
                            parcelCsvRows["NDRE"] = rows;
                            allCsvData["NDRE"] = rows.map(function(row) {
                                return { date: row["C0/date"], mean: toNumber(row["C0/mean"]), min: toNumber(row["C0/min"]), max: toNumber(row["C0/max"]), median: toNumber(row["C0/median"]), cloud: toNumber(row["C0/cloudCoveragePercent"]) };
                            }).filter(function(row) { return row.date && row.mean !== null; });
                        }
                        buildAutoReport();
                    } else {
                        setTimeout(function() { waitForParcelCsv(parcelId, 8, "NDRE"); }, 2000);
                    }
                })
                .catch(function(err) {
                    console.error("NDRE CSV nije dostupan:", err);
                });
        }
        var MAX_CSV_ATTEMPTS = 8;
        function waitForParcelCsv(parcelId, attemptsLeft, indexName) {
            var candidates = buildParcelCsvCandidates(parcelId, "parcel", indexName || "NDVI");
            if (!candidates.length) {
                return;
            }
            var attemptNum = MAX_CSV_ATTEMPTS - attemptsLeft + 1;
            if (attemptNum === 1) {
                console.log("Tra≈æim CSV za parcelu " + parcelId + ", kandidati:", candidates);
            }
            fetchFirstCsv(candidates)
                .then(function(result) {
                    console.log("CSV pronaƒëen:", result.path);
                    buildAutoReport();
                })
                .catch(function(err) {
                    if (attemptsLeft <= 1) {
                        console.log("CSV nije pronaƒëen nakon " + MAX_CSV_ATTEMPTS + " poku≈°aja. Kandidati:", candidates);
                        buildAutoReport();
                        return;
                    }
                    setTimeout(function() {
                        waitForParcelCsv(parcelId, attemptsLeft - 1, indexName || "NDVI");
                    }, 2000);
                });
        }

        function loadTamis() {
            if (tamisLoaded) return;
            tamisLoaded = true;
            fetch(wfsUrlTamis)
                .then(function(response) { 
                    if (!response.ok) {
                        throw new Error("HTTP " + response.status);
                    }
                    return response.json(); 
                })
                .then(function(data) {
                    if (data.features && data.features.length > 0) {
                        tamisLayer.addData(data);
                        console.log("Tamis uƒçitano:", data.features.length, "taƒçka");
                    }
                })
                .catch(function(error) {
                    console.error("Gre≈°ka kod WFS zahteva (Tamis):", error);
                });
        }

        map.on("overlayadd", function(e) {
            if (e.layer === opstineLatLayer) {
                map.fitBounds(serbiaBounds, { padding: [20, 20], maxZoom: 8 });
                showOpstineLoadingOverlay();
                var p = loadOpstineLat();
                (p && typeof p.finally === "function" ? p : Promise.resolve()).finally(hideOpstineLoadingOverlay);
            } else if (e.layer === katOpstineLayer) {
                map.fitBounds(serbiaBounds, { padding: [20, 20], maxZoom: 8 });
                showOpstineLoadingOverlay(t("loading"), t("kat_opstine"));
                var p = loadKatOpstine();
                (p && typeof p.finally === "function" ? p : Promise.resolve()).finally(hideOpstineLoadingOverlay);
            } else if (e.layer === dkpLayer) {
                map.setView([45.05, 21.335], 11);  // centar pomeren ~10% ju≈ænije da Vr≈°ac bude vi≈°e na ekranu
                showOpstineLoadingOverlay(t("loading"), t("dkp_vrsac"));
                var p = loadDkp();
                (p && typeof p.finally === "function" ? p : Promise.resolve()).finally(hideOpstineLoadingOverlay);
            } else if (e.layer === kovinLayer) {
                showOpstineLoadingOverlay(t("loading"), t("dkp_kovin"));
                map.fitBounds(kovinBounds, { maxZoom: 11 });  // zum na op≈°tinu Kovin ‚Äì ostaje i posle uƒçitavanja
                var p = loadKovin();
                (p && typeof p.finally === "function" ? p : Promise.resolve()).finally(hideOpstineLoadingOverlay);
            } else if (e.layer === pancevoLayer) {
                showOpstineLoadingOverlay(t("loading"), t("dkp_pancevo"));
                map.fitBounds(pancevoBounds, { maxZoom: 11 });  // zum na op≈°tinu Panƒçevo ‚Äì ostaje i posle uƒçitavanja
                var p = loadPancevo();
                (p && typeof p.finally === "function" ? p : Promise.resolve()).finally(hideOpstineLoadingOverlay);
            } else if (e.layer === pancevoAdreseLayer) {
                loadPancevoAdrese();
            } else if (e.layer === tamisLayer) {
                map.setView([TAMIS_LAT, TAMIS_LON], 15);
            } else if (e.layer === ndreZonesParcelWms) {
                ndreZonesParcelWms.setOpacity(1.0);
                var slider = document.getElementById("ndreZonesParcelOpacity");
                if (slider) slider.value = 100;
                // Panel levo: samo ako je parcela izabrana i NDRE ukljuƒçen
                updateNdreSnapshotPanelVisibility();
            }
        });
        map.on('layerremove', function(e) {
            if (e.layer === ndreZonesParcelWms) {
                updateNdreSnapshotPanelVisibility();
            }
        });
        window.addEventListener("resize", function() {
            var el = document.getElementById("ndreZonesLegend");
            if (el && el.style.display === "block") updateNdreSnapshotPanelVisibility();
        });

        // Vremenski grafikon funkcije
        function toggleTimeChart() {
            var content = document.getElementById("timeChartContent");
            var toggle = document.getElementById("timeChartToggle");
            if (!content || !toggle) return; // sidebar tab uklonjen, grafikon se otvara preko ikone gore levo
            if (content.style.display === "none") {
                content.style.display = "block";
                toggle.textContent = "‚ñ≤";
                if (timeChart === null && Object.keys(allCsvData).length > 0) {
                    updateTimeChart();
                }
            } else {
                content.style.display = "none";
                toggle.textContent = "‚ñº";
            }
        }

        function setTimeRange(days) {
            console.log("setTimeRange pozvan sa:", days);
            currentTimeRange = days;
            // A≈æuriraj aktivni dugme
            document.querySelectorAll(".time-range-btn").forEach(function(btn) {
                btn.classList.remove("active");
                if (parseInt(btn.getAttribute("data-days")) === days) {
                    btn.classList.add("active");
                }
            });
            // A≈æuriraj grafikon (sidebar i overlay ako je otvoren)
            if (Object.keys(allCsvData).length > 0) {
                updateTimeChart();
            } else {
                console.log("Nema podataka za grafikon");
            }
        }

        function updateTimeChart(canvasId) {
            var targetId = canvasId || "timeChart";
            var ctx = document.getElementById(targetId);
            if (!ctx) {
                console.error("Canvas element '" + targetId + "' nije pronaƒëen!");
                return;
            }

            console.log("updateTimeChart pozvan, currentTimeRange:", currentTimeRange, "target:", targetId);
            console.log("allCsvData keys:", Object.keys(allCsvData));

            // Uni≈°ti postojeƒái grafikon (sidebar ili overlay)
            if (targetId === "timeChartOverlayCanvas") {
                if (timeChartOverlay !== null) {
                    timeChartOverlay.destroy();
                    timeChartOverlay = null;
                }
            } else {
                if (timeChart !== null) {
                    console.log("Uni≈°tavam postojeƒái grafikon");
                    timeChart.destroy();
                    timeChart = null;
                }
            }

            var now = new Date();
            var cutoffDate = new Date(now.getTime() - currentTimeRange * 24 * 60 * 60 * 1000);

            var datasets = [];
            var colors = {
                "NDVI": { border: "rgb(34, 197, 94)", bg: "rgba(34, 197, 94, 0.1)" },
                "NDMI": { border: "rgb(59, 130, 246)", bg: "rgba(59, 130, 246, 0.1)" },
                "NDRE": { border: "rgb(168, 85, 247)", bg: "rgba(168, 85, 247, 0.1)" }
            };

            ["NDVI", "NDMI", "NDRE"].forEach(function(indexName) {
                var data = allCsvData[indexName] || [];
                if (data.length === 0) {
                    return;
                }

                // Filtriraj po vremenu i sortiraj
                var filtered = data.filter(function(row) {
                    try {
                        var date = new Date(row.date);
                        return date >= cutoffDate && row.mean !== null && row.mean !== undefined && !isNaN(row.mean);
                    } catch (e) {
                        return false;
                    }
                }).sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });

                if (filtered.length === 0) {
                    return;
                }

                // Konvertuj datume u timestamp za x osu
                var chartData = filtered.map(function(row) {
                    var date = new Date(row.date);
                    return {
                        x: date.getTime(), // Koristi timestamp umesto stringa
                        y: parseFloat(row.mean) || 0
                    };
                });

                datasets.push({
                    label: indexName + " (mean)",
                    data: chartData,
                    borderColor: colors[indexName].border,
                    backgroundColor: colors[indexName].bg,
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 2,
                    pointHoverRadius: 4
                });
            });

            if (datasets.length === 0) {
                console.log("Nema podataka za prikaz na grafikonu");
                return;
            }

            console.log("Kreiram grafikon sa", datasets.length, "dataset-ova, opseg:", currentTimeRange, "dana");
            
            // Proveri da li canvas postoji
            if (!ctx || !ctx.getContext) {
                console.error("Canvas element nije pronaƒëen!");
                return;
            }

            var chartInstance = new Chart(ctx, {
                type: "line",
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: "top"
                        },
                        tooltip: {
                            mode: "index",
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    var timestamp = context[0].parsed.x;
                                    var date = new Date(timestamp);
                                    return date.toLocaleDateString("sr-RS", { 
                                        year: "numeric", 
                                        month: "long", 
                                        day: "numeric",
                                        hour: "2-digit",
                                        minute: "2-digit"
                                    });
                                },
                                label: function(context) {
                                    return context.dataset.label + ": " + context.parsed.y.toFixed(3);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: "linear",
                            position: "bottom",
                            title: {
                                display: true,
                                text: "Datum"
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    var date = new Date(value);
                                    if (currentTimeRange <= 90) {
                                        return date.toLocaleDateString("sr-RS", { month: "short", day: "numeric" });
                                    } else if (currentTimeRange > 365) {
                                        return date.getFullYear().toString();
                                    } else {
                                        return date.toLocaleDateString("sr-RS", { month: "short", year: "numeric" });
                                    }
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: "Vrednost indeksa"
                            },
                            min: -0.5,
                            max: 1.0
                        }
                    },
                    interaction: {
                        mode: "nearest",
                        axis: "x",
                        intersect: false
                    }
                }
            });
            if (targetId === "timeChartOverlayCanvas") {
                timeChartOverlay = chartInstance;
            } else {
                timeChart = chartInstance;
                // Ako je overlay otvoren, a≈æuriraj i njega
                var overlay = document.getElementById("chartOverlay");
                if (overlay && overlay.classList.contains("visible")) {
                    updateTimeChart("timeChartOverlayCanvas");
                }
            }
        }

        // buildAutoReport koristi parcelCsvRows iz API-ja kada postoji (bez resetovanja podataka)
        buildAutoReport = function() {
            var myVersion = ++_autoReportVersion;
            var reportEl = document.getElementById("autoReport");
            var parcelId = currentParcelId || document.getElementById("parcelInput").value.trim();
            var sources = [];
            if (parcelId) {
                sources = [
                    { label: t("ndvi_parcela"), index: "NDVI", candidates: buildParcelCsvCandidates(parcelId, "parcel", "NDVI") },
                    { label: t("ndmi_parcela"), index: "NDMI", candidates: buildParcelCsvCandidates(parcelId, "parcel", "NDMI") },
                    { label: t("ndre_parcela"), index: "NDRE", candidates: buildParcelCsvCandidates(parcelId, "parcel", "NDRE") }
                ];
            } else {
                sources = [];
            }
            var blockByIndex = {};
            var pending = sources.length;
            if (sources.length === 0) {
                var rEl = document.getElementById("autoReport");
                if (rEl) rEl.innerHTML = "<p>" + t("select_parcel_stats") + "</p>";
                return;
            }
            sources.forEach(function(src) {
                var dataPromise = (parcelCsvRows[src.index] && parcelCsvRows[src.index].length > 0)
                    ? Promise.resolve({ path: "api", text: "", rows: parcelCsvRows[src.index] })
                    : fetchFirstCsv(src.candidates || []).then(function(result) {
                        return { path: result.path, text: result.text, rows: parseCsv(result.text) };
                    });
                dataPromise
                    .then(function(data) {
                        var rows = data.rows;
                        
                        // Saƒçuvaj podatke za grafikon (iz fetch-a; iz API-ja veƒá imamo u allCsvData)
                        if (parcelId && rows.length > 0 && !(parcelCsvRows[src.index] && parcelCsvRows[src.index].length > 0)) {
                            allCsvData[src.index] = rows.map(function(row) {
                                return {
                                    date: row["C0/date"],
                                    mean: toNumber(row["C0/mean"]),
                                    min: toNumber(row["C0/min"]),
                                    max: toNumber(row["C0/max"]),
                                    median: toNumber(row["C0/median"]),
                                    cloud: toNumber(row["C0/cloudCoveragePercent"])
                                };
                            }).filter(function(row) {
                                return row.date && row.mean !== null;
                            });
                        }
                        
                        var idxLabel = src.index || "NDVI";
                        var picked = pickLatestGood(rows);
                        var latest, previous, mean, median, p10, p90, min, max, previousMean, latestDate, period;
                        var textParts = [];
                        
                        if (parcelId) {
                            textParts.push(t("parcel_label") + " " + parcelId);
                        }
                        
                        // Za NDMI i NDRE - prika≈æi validne rezultate za poslednjih 30 dana
                        if (idxLabel !== "NDVI") {
                            var cutoffReport = new Date(Date.now() - reportPanelDays * 24 * 60 * 60 * 1000);
                            var allRows = rows.filter(function(row) {
                                return row["C0/date"] && toNumber(row["C0/mean"]) !== null;
                            });
                            allRows.sort(function(a, b) {
                                return new Date(b["C0/date"]).getTime() - new Date(a["C0/date"]).getTime();
                            });
                            var allRowsPanel = allRows.filter(function(row) {
                                return new Date(row["C0/date"]) >= cutoffReport;
                            });
                            textParts.push(t("total_csv_data") + " " + rows.length + ". " + t("total_csv_shown") + " " + reportPanelDays + " " + t("days_unit") + " " + allRowsPanel.length);
                            textParts.push("---");
                            
                            if (allRowsPanel.length > 0) {
                                textParts.push("<strong>" + t("last_days_1") + " " + reportPanelDays + " " + t("last_days_2") + "</strong>");
                                allRowsPanel.forEach(function(row, idx) {
                                    var rowDate = row["C0/date"];
                                    var rowMean = toNumber(row["C0/mean"]);
                                    var rowMedian = toNumber(row["C0/median"]);
                                    var rowMin = toNumber(row["C0/min"]);
                                    var rowMax = toNumber(row["C0/max"]);
                                    var rowP10 = toNumber(row["C0/p10"]);
                                    var rowP90 = toNumber(row["C0/p90"]);
                                    var rowSampleCount = toNumber(row["C0/sampleCount"]);
                                    var rowNoDataCount = toNumber(row["C0/noDataCount"]) || 0;
                                    var validni = (rowSampleCount !== null) ? (rowSampleCount - rowNoDataCount) : null;
                                    
                                    var dateStr = rowDate ? new Date(rowDate).toLocaleDateString("sr-RS") : "N/A";
                                    var dateTimeStr = rowDate ? new Date(rowDate).toLocaleString("sr-RS") : "N/A";
                                    
                                    textParts.push((idx + 1) + ". " + dateStr + " (" + dateTimeStr + ")");
                                    if (rowMean !== null) {
                                        var interpretation = "";
                                        if (idxLabel === "NDMI") interpretation = interpretNdmi(rowMean);
                                        else if (idxLabel === "NDRE") interpretation = interpretNdre(rowMean);
                                        textParts.push("   " + idxLabel + " Mean: " + rowMean.toFixed(3) + " (" + interpretation + ")");
                                    } else {
                                        textParts.push("   " + idxLabel + " Mean: N/A (oblaci)");
                                    }
                                    if (rowMedian !== null) textParts.push("   Median: " + rowMedian.toFixed(3));
                                    if (rowMin !== null && rowMax !== null) {
                                        textParts.push("   " + t("min_label") + " " + rowMin.toFixed(3) + ", " + t("max_label") + " " + rowMax.toFixed(3));
                                        if (idxLabel === "NDRE") {
                                            textParts.push("   " + t("min_zone_label") + " " + getNdreZone(rowMin) + ", " + t("max_zone_label") + " " + getNdreZone(rowMax));
                                            textParts.push("   Raspon: " + (rowMax - rowMin).toFixed(3));
                                        }
                                    }
                                    if (rowP10 !== null && rowP90 !== null) textParts.push("   p10/p90: " + rowP10.toFixed(3) + " / " + rowP90.toFixed(3));
                                    if (validni !== null) textParts.push("   " + t("valid_pixels_label") + " " + validni);
                                    if (rowNoDataCount > 0) textParts.push("   " + t("pixels_clouds") + " " + rowNoDataCount);
                                    textParts.push("");
                                });
                            } else {
                                if (allRows.length === 0) {
                                    textParts.push("CSV fajl je prazan (nema podataka).");
                                    textParts.push(t("error_reasons"));
                                } else {
                                    textParts.push(t("no_valid_data") + " " + reportPanelDays + " " + t("days_suffix"));
                                    var latestRow = allRows[0];
                                    var latestMean = toNumber(latestRow["C0/mean"]);
                                    var latestMin = toNumber(latestRow["C0/min"]);
                                    var latestMax = toNumber(latestRow["C0/max"]);
                                    var latestMedian = toNumber(latestRow["C0/median"]);
                                    var prevRow = allRows[1];
                                    var prevMean = prevRow ? toNumber(prevRow["C0/mean"]) : null;
                                    if (latestRow && latestMean !== null) {
                                        textParts.push("<strong>Najnoviji validan podatak:</strong>");
                                        textParts.push(t("snapshot_label") + " " + (latestRow["C0/date"] || ""));
                                        textParts.push(idxLabel + " mean: " + latestMean.toFixed(3) + " (" + (idxLabel === "NDMI" ? interpretNdmi(latestMean) : interpretNdre(latestMean)) + ")");
                                        if (latestMin !== null && latestMax !== null) {
                                            if (idxLabel === "NDRE") {
                                                textParts.push(t("min_label") + " " + latestMin.toFixed(3) + " (" + getNdreZone(latestMin) + ")");
                                                textParts.push(t("max_label") + " " + latestMax.toFixed(3) + " (" + getNdreZone(latestMax) + ")");
                                                textParts.push("Raspon: " + (latestMax - latestMin).toFixed(3));
                                            } else {
                                                textParts.push(t("min_label") + " " + latestMin.toFixed(3) + ", " + t("max_label") + " " + latestMax.toFixed(3));
                                            }
                                        }
                                        if (latestMedian !== null) textParts.push("median: " + latestMedian.toFixed(3));
                                        textParts.push(t("trend_label") + " " + trendText(prevMean, latestMean));
                                    }
                                }
                            }
                            blockByIndex[src.index] = { label: src.label, content: textParts.join("<br>") };
                            if (idxLabel === "NDRE" && allRowsPanel.length > 0) {
                                var firstNdre = allRowsPanel[0];
                                var isoDate = firstNdre["C0/date"] ? String(firstNdre["C0/date"]).split("T")[0] : null;
                                if (isoDate && window.setParcelImageDate) window.setParcelImageDate(isoDate);
                            }
                            return;
                        }
                        
                        // Za NDVI - posebna logika (prikaz samo poslednjih 30 dana)
                        if (!picked) {
                            var cutoffReportNdvi = new Date(Date.now() - reportPanelDays * 24 * 60 * 60 * 1000);
                            var allRowsNdvi = rows.filter(function(row) {
                                return row["C0/date"] && toNumber(row["C0/mean"]) !== null;
                            });
                            allRowsNdvi.sort(function(a, b) {
                                return new Date(b["C0/date"]).getTime() - new Date(a["C0/date"]).getTime();
                            });
                            var allRowsNdviPanel = allRowsNdvi.filter(function(row) {
                                return new Date(row["C0/date"]) >= cutoffReportNdvi;
                            });
                            textParts.push(t("total_csv_data") + " " + rows.length + ". " + t("total_csv_shown") + " " + reportPanelDays + " " + t("days_unit") + " " + allRowsNdviPanel.length);
                            textParts.push("---");
                            
                            if (allRowsNdvi.length > 0) {
                                var goodForLayer = allRowsNdvi.filter(function(r) { return toNumber(r["C0/mean"]) !== null; });
                                if (goodForLayer.length > 0) {
                                    var first = allRowsNdvi.find(function(r) { return toNumber(r["C0/mean"]) !== null; });
                                    if (first) setNdviLayerForParcel(parcelId, new Date(first["C0/date"]).toISOString().split('T')[0]);
                                }
                                if (allRowsNdviPanel.length > 0) {
                                    textParts.push("<strong>" + t("last_days_1") + " " + reportPanelDays + " " + t("last_days_2") + "</strong>");
                                    allRowsNdviPanel.forEach(function(row, idx) {
                                    var rowDate = row["C0/date"];
                                    var rowMean = toNumber(row["C0/mean"]);
                                    var rowMedian = toNumber(row["C0/median"]);
                                    var rowMin = toNumber(row["C0/min"]);
                                    var rowMax = toNumber(row["C0/max"]);
                                    var rowSampleCount = toNumber(row["C0/sampleCount"]);
                                    var rowNoDataCount = toNumber(row["C0/noDataCount"]) || 0;
                                    var validni = (rowSampleCount !== null) ? (rowSampleCount - rowNoDataCount) : null;
                                    
                                    var dateStr = rowDate ? new Date(rowDate).toLocaleDateString("sr-RS") : "N/A";
                                    var dateTimeStr = rowDate ? new Date(rowDate).toLocaleString("sr-RS") : "N/A";
                                    
                                    textParts.push((idx + 1) + ". " + dateStr + " (" + dateTimeStr + ")");
                                    if (rowMean !== null) {
                                        textParts.push("   " + t("ndvi_mean_label") + " " + rowMean.toFixed(3) + " (" + interpretNdvi(rowMean) + ")");
                                    } else {
                                        textParts.push("   " + t("ndvi_mean_clouds"));
                                    }
                                    if (rowMedian !== null) textParts.push("   Median: " + rowMedian.toFixed(3));
                                    if (rowMin !== null && rowMax !== null) textParts.push("   " + t("min_label") + " " + rowMin.toFixed(3) + ", " + t("max_label") + " " + rowMax.toFixed(3));
                                    if (validni !== null) textParts.push("   " + t("valid_pixels_label") + " " + validni);
                                    if (rowNoDataCount > 0) textParts.push("   " + t("pixels_clouds") + " " + rowNoDataCount);
                                    textParts.push("");
                                    });
                                } else {
                                    textParts.push(t("no_valid_data") + " " + reportPanelDays + " " + t("days_suffix"));
                                }
                            } else {
                                textParts.push("CSV fajl je prazan (nema podataka).");
                            }
                            blockByIndex[src.index] = { label: src.label, content: textParts.join("<br>") };
                            return;
                        }
                        
                        latest = picked.latest;
                        previous = picked.previous;
                        mean = toNumber(latest["C0/mean"]);
                        median = toNumber(latest["C0/median"]);
                        p10 = toNumber(latest["C0/p10"]);
                        p90 = toNumber(latest["C0/p90"]);
                        min = toNumber(latest["C0/min"]);
                        max = toNumber(latest["C0/max"]);
                        previousMean = previous ? toNumber(previous["C0/mean"]) : null;
                        latestDate = latest["C0/date"];
                        period = extractPeriodFromPath(data.path);
                        textParts = [];
                        if (parcelId) {
                            textParts.push(t("parcel_label") + " " + parcelId);
                        }
                        // Prika≈æi ukupan broj podataka i broj validnih
                        var totalRows = picked.totalCount || rows.length;
                        var validRows = picked.validCount || 0;
                        textParts.push(t("total_csv_data") + " " + totalRows + " (" + t("valid_in_count") + " " + validRows + ")");
                        textParts.push("---");
                        
                        // Za NDVI prika≈æi validne rezultate za poslednjih 30 dana
                        if (idxLabel === "NDVI") {
                            var cutoffReportNdvi2 = new Date(Date.now() - reportPanelDays * 24 * 60 * 60 * 1000);
                            var allRowsNdvi = rows.filter(function(row) {
                                return row["C0/date"] && toNumber(row["C0/mean"]) !== null;
                            });
                            allRowsNdvi.sort(function(a, b) {
                                return new Date(b["C0/date"]).getTime() - new Date(a["C0/date"]).getTime();
                            });
                            var allRowsNdviPanel2 = allRowsNdvi.filter(function(row) {
                                return new Date(row["C0/date"]) >= cutoffReportNdvi2;
                            });
                            if (allRowsNdvi.length > 0) {
                                var firstValid = allRowsNdvi.find(function(r) { return toNumber(r["C0/mean"]) !== null; });
                                if (firstValid) setNdviLayerForParcel(parcelId, new Date(firstValid["C0/date"]).toISOString().split('T')[0]);
                                if (allRowsNdviPanel2.length > 0) {
                                    textParts.push("<strong>" + t("last_days_1") + " " + reportPanelDays + " " + t("last_days_2") + "</strong>");
                                    allRowsNdviPanel2.forEach(function(row, idx) {
                                    var rowDate = row["C0/date"];
                                    var rowMean = toNumber(row["C0/mean"]);
                                    var rowMedian = toNumber(row["C0/median"]);
                                    var rowMin = toNumber(row["C0/min"]);
                                    var rowMax = toNumber(row["C0/max"]);
                                    var rowSampleCount = toNumber(row["C0/sampleCount"]);
                                    var rowNoDataCount = toNumber(row["C0/noDataCount"]) || 0;
                                    var validni = (rowSampleCount !== null) ? (rowSampleCount - rowNoDataCount) : null;
                                    
                                    var dateStr = rowDate ? new Date(rowDate).toLocaleDateString("sr-RS") : "N/A";
                                    var dateTimeStr = rowDate ? new Date(rowDate).toLocaleString("sr-RS") : "N/A";
                                    
                                    textParts.push((idx + 1) + ". " + dateStr + " (" + dateTimeStr + ")");
                                    if (rowMean !== null) {
                                        textParts.push("   " + t("ndvi_mean_label") + " " + rowMean.toFixed(3) + " (" + interpretNdvi(rowMean) + ")");
                                    } else {
                                        textParts.push("   " + t("ndvi_mean_clouds"));
                                    }
                                    if (rowMedian !== null) textParts.push("   Median: " + rowMedian.toFixed(3));
                                    if (rowMin !== null && rowMax !== null) textParts.push("   " + t("min_label") + " " + rowMin.toFixed(3) + ", " + t("max_label") + " " + rowMax.toFixed(3));
                                    if (validni !== null) textParts.push("   " + t("valid_pixels_label") + " " + validni);
                                    if (rowNoDataCount > 0) textParts.push("   " + t("pixels_clouds") + " " + rowNoDataCount);
                                    textParts.push("");
                                });
                            } else {
                                // Fallback ako nema podataka
                                textParts.push("<strong>Najnoviji validan podatak:</strong>");
                                textParts.push(t("snapshot_label") + " " + latestDate);
                                if (period) {
                                    textParts.push("Period fajla: " + period);
                                }
                                if (mean !== null) {
                                    textParts.push(t("ndvi_mean_simple") + " " + mean.toFixed(3) + " (" + interpretNdvi(mean) + ")");
                                }
                                if (min !== null && max !== null) {
                                    textParts.push(t("min_label") + " " + min.toFixed(3) + ", " + t("max_label") + " " + max.toFixed(3));
                                }
                                if (median !== null) {
                                    textParts.push("median: " + median.toFixed(3));
                                }
                                if (p10 !== null && p90 !== null) {
                                    textParts.push("p10/p90: " + p10.toFixed(3) + " / " + p90.toFixed(3));
                                }
                                textParts.push(t("trend_label") + " " + trendText(previousMean, mean));
                            }
                            }
                        } else {
                            // Za NDMI i NDRE - originalna logika (samo najnoviji podatak)
                            textParts.push("<strong>Najnoviji validan podatak:</strong>");
                            textParts.push(t("snapshot_label") + " " + latestDate);
                            if (period) {
                                textParts.push("Period fajla: " + period);
                            }
                            if (mean !== null) {
                                var interpretation = "";
                                if (idxLabel === "NDMI") {
                                    interpretation = interpretNdmi(mean);
                                } else if (idxLabel === "NDRE") {
                                    interpretation = interpretNdre(mean);
                                }
                                textParts.push(idxLabel + " mean: " + mean.toFixed(3) + " (" + interpretation + ")");
                            }
                            // Za NDRE, prika≈æi min, max i zone; za NDMI samo min, max
                            if (idxLabel === "NDRE" && min !== null && max !== null) {
                                textParts.push(t("min_label") + " " + min.toFixed(3) + " (" + getNdreZone(min) + ")");
                                textParts.push(t("max_label") + " " + max.toFixed(3) + " (" + getNdreZone(max) + ")");
                                textParts.push("Raspon: " + (max - min).toFixed(3));
                            } else if (idxLabel === "NDMI" && min !== null && max !== null) {
                                textParts.push(t("min_label") + " " + min.toFixed(3) + ", " + t("max_label") + " " + max.toFixed(3));
                            }
                            if (median !== null) {
                                textParts.push("median: " + median.toFixed(3));
                            }
                            if (p10 !== null && p90 !== null) {
                                textParts.push("p10/p90: " + p10.toFixed(3) + " / " + p90.toFixed(3));
                            }
                            // Trend u odnosu na prethodni datum (ne prvi u intervalu)
                            textParts.push(t("trend_label") + " " + trendText(previousMean, mean));
                        }
                        blockByIndex[src.index] = { label: src.label, content: textParts.join("<br>") };
                    })
                    .catch(function() {
                        if (parcelId) {
                            var expected = (src.candidates || []).map(function(p) {
                                var m = p.match(/[?&]file=([^&]+)/);
                                if (m) return decodeURIComponent(m[1]);
                                return p.replace("satelite/", "");
                            });
                            var errorLine = lastCsvError ? "<br>" + t("error_label") + " " + lastCsvError : "";
                            blockByIndex[src.index] = { label: src.label, content: t("expected_files") + " " + expected.join(", ") + errorLine };
                        }
                    })
                    .finally(function() {
                        pending -= 1;
                        if (pending === 0) {
                            if (myVersion !== _autoReportVersion) return;
                            var tabOrder = ["NDVI", "NDMI", "NDRE"];
                            var items = tabOrder.filter(function(idx) { return blockByIndex[idx]; }).map(function(idx) { return blockByIndex[idx]; });
                            if (items.length) {
                                var tabsHtml = '<div class="auto-report-tabs">';
                                var contentHtml = '<div class="auto-report-content">';
                                items.forEach(function(item, i) {
                                    var panelId = "autoReportPanel_" + i;
                                    tabsHtml += '<button type="button" class="auto-report-tab' + (i === 0 ? ' active' : '') + '" data-tab="' + panelId + '">' + item.label + '</button>';
                                    contentHtml += '<div id="' + panelId + '" class="auto-report-panel' + (i === 0 ? ' active' : '') + '">' + item.content + '</div>';
                                });
                                tabsHtml += '</div>';
                                contentHtml += '</div>';
                                reportEl.innerHTML = tabsHtml + contentHtml;
                                reportEl.querySelectorAll(".auto-report-tab").forEach(function(btn) {
                                    btn.addEventListener("click", function() {
                                        reportEl.querySelectorAll(".auto-report-tab").forEach(function(b) { b.classList.remove("active"); });
                                        reportEl.querySelectorAll(".auto-report-panel").forEach(function(p) { p.classList.remove("active"); });
                                        btn.classList.add("active");
                                        var panel = document.getElementById(btn.getAttribute("data-tab"));
                                        if (panel) panel.classList.add("active");
                                    });
                                });
                            } else {
                                reportEl.innerHTML = "<div class=\"auto-report-content\"><p>" + t("no_csv_display") + "</p></div>";
                            }
                            reportEl.style.display = "block";
                            
                            // Prika≈æi grafikon ako ima podataka
                            if (parcelId && Object.keys(allCsvData).length > 0) {
                                var chartContainer = document.getElementById("timeChartContainer");
                                if (chartContainer) {
                                    chartContainer.style.display = "block";
                                    if (timeChart === null) {
                                        updateTimeChart();
                                    } else {
                                        updateTimeChart();
                                    }
                                }
                            } else {
                                var chartContainer = document.getElementById("timeChartContainer");
                                if (chartContainer) {
                                    chartContainer.style.display = "none";
                                }
                            }
                        }
                    });
            });
        };
    </script>
</body>
</html>
